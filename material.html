<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control | Línea TRAXX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --primary-dark: #0f2547;
            --secondary: #2d74da;
            --accent: #00b4d8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 80px 1fr;
            grid-template-areas: 
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
            display: none; 
        }

        /* HEADER */
        .header {
            grid-area: header;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
            transition: all 0.3s;
            z-index: 110;
        }
        .menu-toggle:hover {
            color: var(--secondary);
        }
        
        .sync-status, .user-count, .user-selector {
            display: none !important;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            background: var(--gray-50);
            transition: all 0.3s ease;
            cursor: pointer; 
        }

        .user-profile:hover {
            background: var(--gray-100);
        }

        .user-profile.logged-out {
            opacity: 0.5;
            cursor: default;
        }
        .user-profile.logged-out:hover {
            background: var(--gray-50);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .user-profile.logged-out .user-avatar {
             background: var(--gray-600);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-role {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* SIDEBAR */
        .sidebar {
            grid-area: sidebar;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }

        .logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 2rem;
        }

        .logo h2 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            background: var(--accent);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: var(--accent);
            box-shadow: 0 4px 12px rgba(0,180,216,0.3);
        }

        .nav-item.admin-only {
            display: none; 
        }
        .nav-item.admin-only.show {
            display: flex; 
        }

        .nav-icon {
            width: 24px;
            text-align: center;
        }

        .system-status {
            margin-top: auto;
            padding: 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin: 2rem 1rem 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
        }

        .status-value {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-online {
            color: var(--success);
        }

        /* MAIN CONTENT */
        .main-content {
            grid-area: main;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .page-subtitle {
            color: var(--gray-600);
            margin-top: 0.5rem;
        }

        .last-update {
            font-size: 0.875rem;
            color: var(--gray-600);
            padding: 8px 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* STATS CARDS - 4 COLUMNAS FIJAS */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 columnas fijas */
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            text-align: center;
            min-height: 180px; /* Altura mínima consistente */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .stat-card.disponible i {
            color: var(--success);
        }

        .stat-card.en-uso i {
            color: var(--warning);
        }

        .stat-card.mantenimiento i {
            color: var(--danger);
        }

        .stat-card.en-cola i {
            color: var(--gray-600);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 1rem;
            font-weight: 600;
        }

        /* ESTILOS PARA ESTACIONES */
        .stations-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .station-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            text-align: center;
        }

        .station-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        .stats-separator {
            grid-column: 1 / -1;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gray-300), transparent);
            margin: 2rem 0;
        }

        .station-card.estacion-0 i {
            color: var(--success);
        }

        .station-card.estacion-1 i {
            color: var(--secondary);
        }

        .station-card.estacion-2 i {
            color: var(--warning);
        }

        .station-card.estacion-3 i {
            color: var(--accent);
        }

        .station-card.estacion-4 i {
            color: var(--danger);
        }

        .station-card.estacion-5 i {
            color: var(--gray-600);
        }

        .station-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .station-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            color: var(--primary);
        }

        .station-label {
            color: var(--gray-600);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .station-tools {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: left;
        }

        .tool-in-station {
            background-color: white;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-left: 3px solid var(--secondary);
        }

        .tool-in-station:last-child {
            margin-bottom: 0;
        }

        /* PANELS */
        .panel {
            background-color: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        .panel h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.25rem;
        }

        /* NUEVO DISEÑO PARA TABLA DE HERRAMIENTAS */
        .tools-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .section-actions {
            display: flex;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 10px;
            background: var(--gray-50);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 116, 218, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        /* CONTENEDOR PARA TABLA CON SCROLL HORIZONTAL */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* TOOLS TABLE */
        .tools-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        .tools-table th {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }

        .tools-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .tools-table tr:last-child td {
            border-bottom: none;
        }

        .tools-table tr:hover {
            background: var(--gray-50);
        }

        .tool-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tool-icon-table {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        .tool-details {
            display: flex;
            flex-direction: column;
        }

        .tool-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .tool-status {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-in-use {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-maintenance {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ACTION BUTTONS */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .btn-icon-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-icon-primary:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        .btn-icon-outline {
            background: transparent;
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .btn-icon-outline:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-icon-success {
            background: var(--success);
            color: white;
        }

        .btn-icon-success:hover {
            background: #0da271;
            transform: scale(1.05);
        }

        .btn-icon-warning {
            background: var(--warning);
            color: white;
        }

        .btn-icon-warning:hover {
            background: #e67e22;
            transform: scale(1.05);
        }

        /* ESTILOS PARA MODALES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 100vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .modal-title {
            color: var(--primary);
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s;
            background-color: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(45, 116, 218, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 116, 218, 0.3);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-outline:hover {
            background-color: var(--gray-50);
        }

        .btn-queue {
            background-color: var(--success);
            color: white;
        }

        .btn-queue:hover {
            background-color: #0da271;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--accent);
            color: white;
        }

        .btn-info:hover {
            background-color: #0099cc;
            transform: translateY(-2px);
        }

        /* QUEUE AND USAGE */
        .turn-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .waiting-queue, .tools-in-use {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        /* ESTILOS NUEVOS PARA MEJORAS EN LA COLA DE ESPERA */
        
        .queue-info-message {
            text-align: center;
            padding: 1rem;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .queue-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--gray-200);
            border-left: 3px solid var(--secondary);
            position: relative;
        }

        .queue-item.first-in-line {
            border-left: 3px solid var(--success);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, rgba(255, 255, 255, 1) 30%);
        }

        .queue-item.current-user {
            background: linear-gradient(90deg, rgba(45, 116, 218, 0.05) 0%, rgba(255, 255, 255, 1) 30%);
            border-left: 3px solid var(--secondary);
        }

        .queue-position {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .queue-position.first {
            background: var(--success);
        }

        .queue-info {
            flex: 1;
        }

        .queue-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-cancel-queue {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.3s ease;
        }

        .btn-cancel-queue:hover {
            background: #dc2625;
            transform: scale(1.05);
        }

        .first-in-line-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--success);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .current-user-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .queue-group-header {
            margin: 1rem 0 0.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-300);
        }

        .current-usage-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            border-left: 3px solid var(--warning);
        }

        .queue-modal-info {
            text-align: center;
            padding: 1rem;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* HISTORY TABLE */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .history-table th, .history-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .history-table th {
            background-color: var(--gray-50);
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .history-table tr:hover {
            background-color: var(--gray-50);
        }

        .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto; 
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100px);
            transition: opacity 0.5s, transform 0.5s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-success {
            background-color: var(--success);
        }

        .notification-warning {
            background-color: var(--warning);
        }

        .notification-error {
            background-color: var(--danger);
        }

        .notification-info {
            background-color: var(--accent);
        }

        /* PAGE SECTIONS */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }
        
        /* LOGIN OVERLAY */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none; 
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-box h2 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .login-box p {
            color: var(--gray-600);
            margin-bottom: 2rem;
        }

        .login-box .form-group {
            text-align: left;
        }

        .login-box .btn-primary {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* ESTILOS PARA TAREAS */
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .task-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .task-status-pendiente {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .task-status-en-progreso {
            background: rgba(45, 116, 218, 0.1);
            color: var(--secondary);
        }

        .task-status-completada {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .task-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .task-tools {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .tool-requirement {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
        }

        .tool-requirement:last-child {
            margin-bottom: 0;
        }

        .tool-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .tool-status-disponible {
            background: var(--success);
        }

        .tool-status-no-disponible {
            background: var(--danger);
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-task {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.3s;
        }

        .btn-task-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-task-primary:hover {
            background: var(--primary);
        }

        .btn-task-success {
            background: var(--success);
            color: white;
        }

        .btn-task-success:hover {
            background: #0da271;
        }

        .btn-task-outline {
            background: transparent;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-task-outline:hover {
            background: var(--gray-50);
        }

        /* ESTILOS PARA LA SECCIÓN OPERACIONES */
        .operacion-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .operacion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .operacion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .operacion-category {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .category-mantenimiento {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .category-ensamblaje {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .category-calibracion {
            background: rgba(0, 180, 216, 0.1);
            color: var(--accent);
        }

        .operacion-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
        }


        /* RESPONSIVE - TABLETAS Y MÓVILES */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "main";
                min-height: 100vh;
                overflow: hidden;
            }
            
            .menu-toggle {
                display: block; 
                order: -1; 
            }

            .sidebar {
                position: fixed; 
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 100;
                width: 280px; 
                box-shadow: 4px 0 10px rgba(0,0,0,0.4);
                display: flex; 
                transform: translateX(-100%);
                overflow-y: auto;
            }

            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .main-content {
                height: calc(100vh - 80px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 1rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Ajustes para el grid de estaciones en dashboard */
            .stations-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
                height: calc(100vh - 80px);
                overflow-y: auto;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .turn-controls {
                grid-template-columns: 1fr;
            }
            
            .content-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
            }
            
            .table-container {
                border: 1px solid var(--gray-200);
                border-radius: 8px;
                margin-bottom: 1rem;
            }
            
            .tools-table {
                min-width: 600px;
            }
            
            .tools-table th,
            .tools-table td {
                padding: 0.75rem 1rem;
            }
            
            .header-actions {
                flex-direction: row; 
                gap: 1rem;
                align-items: center;
            }
            
            .header-title {
                flex-wrap: wrap; 
                gap: 0.5rem; 
                align-items: flex-start;
            }
            .header-title h1 {
                font-size: 1.2rem; 
            }
            
            .stations-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .task-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .tools-table {
                min-width: 550px;
            }
            
            .tools-table th,
            .tools-table td {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                gap: 0.25rem;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .stations-stats {
                grid-template-columns: 1fr;
            }
            
            .task-actions {
                flex-direction: column;
            }
        }

        /* ESCRITORIO - Menú hamburguesa oculto */
        @media (min-width: 1025px) {
            .menu-toggle {
                display: none !important;
            }
            
            .sidebar {
                transform: translateX(0) !important;
                position: relative !important;
                box-shadow: none !important;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <h2>Acceso al Sistema TRAXX</h2>
            <p>Por favor, ingrese sus credenciales para continuar.</p>
            <div class="form-group">
                <label for="login-username">Usuario</label>
                <input type="text" id="login-username" placeholder="op1 o admin" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="login-password">Contraseña</label>
                <input type="password" id="login-password" placeholder="1234" autocomplete="current-password">
            </div>
            <p class="error-message" id="login-error-message" style="display:none; color: var(--danger); margin-top: 1rem;"></p>
            <button class="btn btn-primary" id="login-button">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
            </button>
        </div>
    </div>

    <!-- Overlay para el menú móvil -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container" id="app-container">
        <header class="header">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="header-title">
                <h1>Sistema de Control </h1>
            </div>
            <div class="header-actions">
                
                <div class="user-profile logged-out" id="user-profile-logout-btn" title="Click para cerrar sesión"> 
                    <div class="user-avatar" id="user-avatar">?</div>
                    <div class="user-info">
                        <span class="user-name" id="user-name">Usuario No Autenticado</span>
                        <span class="user-role" id="user-role"></span>
                    </div>
                </div>
            </div>
        </header>

        <nav class="sidebar">
            <div class="logo">
                <h2>
                    <div class="logo-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    TRAXX Tools
                </h2>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home nav-icon"></i>
                    Dashboard
                </a>
                <a href="#" class="nav-item" data-page="herramientas">
                    <i class="fas fa-tools nav-icon"></i>
                    Herramientas
                </a>
                <a href="#" class="nav-item" data-page="materiales">
                    <i class="fas fa-flask nav-icon"></i>
                    Materiales
                </a>
				<a href="#" class="nav-item" data-page="operaciones">
    <i class="fas fa-cogs nav-icon"></i>
    Operaciones
</a>
                <a href="#" class="nav-item" data-page="tareas">
                    <i class="fas fa-tasks nav-icon"></i>
                    Tareas
                </a>

<a href="#" class="nav-item" data-page="instrucciones">
    <i class="fas fa-file-alt nav-icon"></i>
    Instrucciones
</a>
                <a href="#" class="nav-item" data-page="en-espera">
                    <i class="fas fa-users nav-icon"></i>
                    En Espera
                </a>
                <a href="#" class="nav-item" data-page="historial">
                    <i class="fas fa-history nav-icon"></i>
                    Historial
                </a>
                <a href="#" class="nav-item" data-page="reportes">
                    <i class="fas fa-chart-bar nav-icon"></i>
                    Reportes
                </a>
                <a href="#" class="nav-item admin-only" data-page="configuracion">
    <i class="fas fa-cogs nav-icon"></i>
    Configuración Avanzada
</a>
            </div>
            
            <div class="system-status">
                <div class="status-item">
                    <span class="status-label">Estado del Sistema</span>
                    <span class="status-value status-online">Operativo</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Última Actualización</span>
                    <span class="status-value" id="sidebar-update-time">Cargando...</span>
                </div>
            </div>
        </nav>
		
        <main class="main-content">
		
		<!-- Pagina Principal -->
            <div id="dashboard" class="page-section active">
                <div class="content-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Control y gestión de herramientas en tiempo real</p>
                    </div>
                    <div class="last-update" id="last-update">
                        Última actualización: <span id="update-time">Cargando...</span>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card disponible">
                        <i class="fas fa-check-circle"></i>
                        <div class="stat-value" id="disponible-count">0</div>
                        <div class="stat-label">Disponibles</div>
                    </div>
                    <div class="stat-card en-uso">
                        <i class="fas fa-user-check"></i>
                        <div class="stat-value" id="en-uso-count">0</div>
                        <div class="stat-label">En Uso</div>
                    </div>
                    <div class="stat-card mantenimiento">
                        <i class="fas fa-toolbox"></i>
                        <div class="stat-value" id="mantenimiento-count">0</div>
                        <div class="stat-label">Mantenimiento</div>
                    </div>
                    <div class="stat-card en-cola">
                        <i class="fas fa-users"></i>
                        <div class="stat-value" id="en-cola-count">0</div>
                        <div class="stat-label">En Cola</div>
                    </div>
                </div>

                <div class="stats-separator"></div>

                <div class="stations-stats" id="stations">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Cargando estaciones...
                    </div>
                </div>
            </div>

        <!-- Pagina Herramientas -->
     		<div id="herramientas" class="page-section">
                <div class="content-header">
                    <div>
                        <h1 class="page-title">Inventario</h1>
                        <p class="page-subtitle">Herramientas disponibles, en uso y en mantenimiento</p>
                    </div>
                    <div class="last-update" id="herramientas-update-time">
                        Última actualización: <span id="herramientas-update">Cargando...</span>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="section-header">
                        <h2 class="section-title">Inventario de Herramientas</h2>
                        <div class="section-actions">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="herramientas-search-tool" placeholder="Buscar herramienta...">
                            </div>
                            <button class="btn btn-primary" id="add-tool-btn" style="display:none;"><i class="fas fa-plus"></i> Añadir</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="tools-table">
                            <thead>
                                <tr>
                                    <th>Herramienta</th>
                                    <th>Número de Serie</th>
                                    <th>Ubicación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="herramientas-tool-list">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem;">
                                        <div class="loading">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando herramientas...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        <!-- Pagina Materiales -->
            <div id="materiales" class="page-section">
                <div class="content-header">
                    <div>
                        <h1 class="page-title">Inventario de Materiales</h1>
                        <p class="page-subtitle">Materiales disponibles y en uso</p>
                    </div>
                    <div class="last-update" id="materiales-update-time">
                        Última actualización: <span id="materiales-update">Cargando...</span>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="section-header">
                        <h2 class="section-title">Inventario de Materiales</h2>
                        <div class="section-actions">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="materiales-search" placeholder="Buscar material...">
                            </div>
                            <button class="btn btn-primary" id="add-material-btn" style="display:none;"><i class="fas fa-plus"></i> Añadir</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="tools-table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Código</th>
                                    <th>Ubicación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="materiales-list">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 2rem;">
                                        <div class="loading">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando materiales...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        <!-- Pagina Operaciones -->
<div id="operaciones" class="page-section">
    <div class="content-header">
        <div>
            <h1 class="page-title">Operaciones Disponibles</h1>
            <p class="page-subtitle">Selecciona una operación para ver detalles y comenzar</p>
        </div>
        <div class="last-update" id="operaciones-update-time">
            Última actualización: <span id="operaciones-update">Cargando...</span>
        </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="panel" style="margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div class="search-box" style="flex: 1;">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="operaciones-search" placeholder="Buscar operación...">
            </div>
            <div>
                <select id="operaciones-filter" style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 8px;">
                    <option value="todas">Todas las operaciones</option>
                    <option value="mantenimiento">Mantenimiento</option>
                    <option value="ensamblaje">Ensamblaje</option>
                    <option value="calibracion">Calibración</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Lista de Operaciones -->
    <div class="panel">
        <h2><i class="fas fa-list"></i> Catálogo de Operaciones</h2>
        
        <div id="operaciones-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            <!-- Las operaciones se cargarán aquí dinámicamente -->
            <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin"></i> Cargando operaciones...
            </div>
        </div>
    </div>
</div>
        <!-- Pagina Tareas -->
            <div id="tareas" class="page-section">
                <div class="content-header">
                    <div>
                        <h1 class="page-title">Tareas</h1>
                        <p class="page-subtitle">Gestión de tareas y operaciones específicas</p>
                    </div>
                    <div class="last-update" id="tareas-update-time">
                        Última actualización: <span id="tareas-update">Cargando...</span>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-header">
                        <h2><i class="fas fa-tasks"></i> Lista de Tareas</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary" id="add-task-btn">
                                <i class="fas fa-plus"></i> Nueva Tarea
                            </button>
                        </div>
                    </div>
                    
                    <div id="tasks-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Cargando tareas...
                        </div>
                    </div>
                </div>
            </div>

<!-- Pagina Instrucciones -->
<div id="instrucciones" class="page-section">
    <div class="content-header">
        <div>
            <h1 class="page-title">Instrucciones de Operación</h1>
            <p class="page-subtitle">Procedimientos y documentación para operaciones específicas</p>
        </div>
        <div class="last-update" id="instrucciones-update-time">
            Última actualización: <span id="instrucciones-update">Cargando...</span>
        </div>
    </div>

    <div class="panel">
        <h2><i class="fas fa-list"></i> Operaciones Disponibles</h2>
        
        <!-- Tarjeta Seccionador -->
        <div class="task-card" style="cursor: pointer;" onclick="window.tallerSystem.showOperationInstructions('seccionador')">
            <div class="task-header">
                <div class="task-title">
                    <i class="fas fa-bolt"></i> Operación Seccionador
                </div>
                <div class="task-status task-status-pendiente">
                    Disponible
                </div>
            </div>
            <div class="task-details">
                <div>
                    <strong>Operación:</strong> 150<br>
                    <strong>Descripción:</strong> Mantenimiento y calibración de seccionador principal
                </div>
                <div>
                    <strong>Duración estimada:</strong> 2.5 horas<br>
                    <strong>Dificultad:</strong> <span style="color: var(--warning);">Media</span>
                </div>
            </div>
            <div class="task-tools">
                <h4>Documentación Disponible</h4>
                <div class="tool-requirement">
                    <div class="tool-status-indicator tool-status-disponible"></div>
                    <div>
                        <strong>Manual de Procedimiento</strong> (PDF)
                    </div>
                </div>
                <div class="tool-requirement">
                    <div class="tool-status-indicator tool-status-disponible"></div>
                    <div>
                        <strong>Diagramas Técnicos</strong> (PDF)
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta QB0300 -->
        <div class="task-card" style="cursor: pointer;" onclick="window.tallerSystem.showOperationInstructions('qb0300')">
            <div class="task-header">
                <div class="task-title">
                    <i class="fas fa-cogs"></i> Operación QB0300
                </div>
                <div class="task-status task-status-pendiente">
                    Disponible
                </div>
            </div>
            <div class="task-details">
                <div>
                    <strong>Operación:</strong> QB0300<br>
                    <strong>Descripción:</strong> Ensamblaje y verificación de componente QB0300
                </div>
                <div>
                    <strong>Duración estimada:</strong> 1.5 horas<br>
                    <strong>Dificultad:</strong> <span style="color: var(--success);">Baja</span>
                </div>
            </div>
            <div class="task-tools">
                <h4>Documentación Disponible</h4>
                <div class="tool-requirement">
                    <div class="tool-status-indicator tool-status-disponible"></div>
                    <div>
                        <strong>Guía de Ensamblaje</strong> (PDF)
                    </div>
                </div>
                <div class="tool-requirement">
                    <div class="tool-status-indicator tool-status-disponible"></div>
                    <div>
                        <strong>Lista de Verificación</strong> (PDF)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <!-- Pagina En Espera -->		
		    <div id="en-espera" class="page-section">
                <div class="content-header">
                    <div>
                        <h1 class="page-title">En Espera</h1>
                        <p class="page-subtitle">Gestión de En Espera y colas</p>
                    </div>
                    <div class="last-update" id="en-espera-update-time">
                        Última actualización: <span id="en-espera-update">Cargando...</span>
                    </div>
                </div>

                <div class="panel">
                    <h2><i class="fas fa-users"></i> Sistema de Espera</h2>
                    <div class="turn-controls">
                        <div class="waiting-queue">
                            <h4><i class="fas fa-list-ol"></i> En Espera</h4>
                            <div id="waiting-list">
                                <div class="queue-item">
                                    <div class="queue-info">
                                        <div>No hay operarios en espera</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tools-in-use">
                            <h4><i class="fas fa-tools"></i> En Uso Actualmente</h4>
                            <div id="operarios-current-usage">
                                <div class="current-usage-item">
                                    <div>No hay herramientas en uso</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Pagina Historial -->
		    <div id="historial" class="page-section">
                <div class="content-header">
                    <h1 class="page-title">Historial</h1>
                    <p class="page-subtitle">Registro completo de movimientos</p>
                </div>
                
                <div class="panel">
                    <h2><i class="fas fa-history"></i> Historial Completo</h2>
                    <div class="history-table-container">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Operario</th>
                                    <th>Fecha/Hora</th>
                                    <th>Herramienta</th>
                                    <th>Serie</th>
                                    <th>Operación</th>
                                    <th>Acción</th>
                                    <th>Estación</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">
                                        <div class="loading">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        <!-- Pagina Reportes -->
			<div id="reportes" class="page-section">
                <div class="content-header">
                    <h1 class="page-title">Reportes y Estadísticas</h1>
                    <p class="page-subtitle">Informes de uso y mantenimiento</p>
                </div>
                
                <div class="panel" style="text-align: center; padding: 4rem;">
                    <h2><i class="fas fa-chart-bar"></i> Sección en desarrollo</h2>
                    <p>Informes de uso y promedios de tiempo.</p>
                </div>
            </div>

        <!-- Pagina Configuracion Avanzada -->
<div id="configuracion" class="page-section">
    <div class="content-header">
        <h1 class="page-title">Configuración Avanzada del Sistema</h1>
        <p class="page-subtitle">Gestión completa de operaciones, herramientas, materiales e instrucciones</p>
    </div>

    <!-- Panel de Acceso Administrativo -->
    <div class="panel" id="admin-access-panel" style="display: none;">
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--danger); margin-bottom: 1rem;"></i>
            <h3 style="color: var(--danger);">Acceso Restringido</h3>
            <p>Esta sección solo está disponible para administradores del sistema.</p>
            <button class="btn btn-outline" onclick="window.tallerSystem.showLoginScreen()">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesión como Administrador
            </button>
        </div>
    </div>

    <!-- Contenido Administrativo (solo visible para admins) -->
    <div id="admin-content" style="display: none;">
        
        <!-- RESUMEN DEL SISTEMA -->
        <div class="stats" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <i class="fas fa-tools" style="color: var(--secondary);"></i>
                <div class="stat-value" id="config-tools-count">0</div>
                <div class="stat-label">Herramientas</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-flask" style="color: var(--accent);"></i>
                <div class="stat-value" id="config-materials-count">0</div>
                <div class="stat-label">Materiales</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-file-alt" style="color: var(--warning);"></i>
                <div class="stat-value" id="config-operations-count">2</div>
                <div class="stat-label">Operaciones</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-users" style="color: var(--success);"></i>
                <div class="stat-value" id="config-users-count">0</div>
                <div class="stat-label">Usuarios</div>
            </div>
        </div>

        <!-- PANELES DE CONFIGURACIÓN -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            
            <!-- GESTIÓN DE OPERACIONES -->
            <div class="panel">
                <h2><i class="fas fa-file-alt"></i> Gestión de Operaciones</h2>
                <p>Crear y editar operaciones disponibles en el sistema.</p>
                
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    <div id="operations-list">
                        <!-- Las operaciones se cargarán aquí -->
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="window.tallerSystem.showAddOperationModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i> Añadir Nueva Operación
                </button>
            </div>

            <!-- GESTIÓN DE HERRAMIENTAS -->
            <div class="panel">
                <h2><i class="fas fa-tools"></i> Gestión de Herramientas</h2>
                <p>Administrar inventario de herramientas y grupos.</p>
                
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    <div id="tools-management-list">
                        <!-- Las herramientas se cargarán aquí -->
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="window.tallerSystem.showAddToolModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i> Añadir Nueva Herramienta
                </button>
            </div>

            <!-- GESTIÓN DE MATERIALES -->
            <div class="panel">
                <h2><i class="fas fa-flask"></i> Gestión de Materiales</h2>
                <p>Control de inventario y stock de materiales.</p>
                
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    <div id="materials-management-list">
                        <!-- Los materiales se cargarán aquí -->
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="window.tallerSystem.showAddMaterialModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i> Añadir Nuevo Material
                </button>
            </div>

            <!-- GESTIÓN DE USUARIOS -->
            <div class="panel">
                <h2><i class="fas fa-users-cog"></i> Gestión de Usuarios</h2>
                <p>Administrar usuarios y permisos del sistema.</p>
                
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    <div id="users-management-list">
                        <!-- Los usuarios se cargarán aquí -->
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="window.tallerSystem.showAddUserModal()" style="width: 100%;">
                    <i class="fas fa-plus"></i> Añadir Nuevo Usuario
                </button>
            </div>
        </div>

        <!-- CONFIGURACIONES AVANZADAS -->
        <div class="panel">
            <h2><i class="fas fa-sliders-h"></i> Configuraciones del Sistema</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Ajustes Generales</h4>
                    
                    <div class="form-group">
                        <label for="system-name">Nombre del Sistema</label>
                        <input type="text" id="system-name" value="Sistema TRAXX" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-save">Guardado Automático</label>
                        <select id="auto-save" class="form-control">
                            <option value="true">Activado</option>
                            <option value="false">Desactivado</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Acciones Peligrosas</h4>
                    
                    <button class="btn btn-outline" onclick="window.tallerSystem.exportSystemData()" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-download"></i> Exportar Datos del Sistema
                    </button>
                    
                    <button class="btn btn-outline" onclick="window.tallerSystem.showResetSystemModal()" style="width: 100%; margin-bottom: 0.5rem;">
                        <i class="fas fa-trash"></i> Restablecer Sistema
                    </button>
                    
                    <button class="btn btn-danger" onclick="window.tallerSystem.showClearDataModal()" style="width: 100%;">
                        <i class="fas fa-broom"></i> Limpiar Todos los Datos
                    </button>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-outline">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-primary" onclick="window.tallerSystem.saveSystemSettings()">
                    <i class="fas fa-save"></i> Guardar Configuración
                </button>
            </div>
        </div>
    </div>
</div>
        </main>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
    // CONFIGURACIÓN FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBZvSfAi2AO_FF1rqDqKDH6-VDFrbeCdhg",
        authDomain: "taller-herramientas-79e58.firebaseapp.com",
        projectId: "taller-herramientas-79e58",
        storageBucket: "taller-herramientas-79e58.firebasestorage.app",
        messagingSenderId: "1010208693381",
        appId: "1:1010208693381:web:cd5736b779a41d2c4eddec"
    };

    class TallerSystem {
        constructor() {
            this.db = null;
            this.unsubscribe = null;
            this.userId = 'user_' + Math.random().toString(36).substr(2, 9);
            this.userName = ''; 
            this.userRole = ''; 
            this.isLoggedIn = false;
            
            // Credenciales de Login
            this.loginUsers = JSON.parse(localStorage.getItem('taller_login_users')) || {
                'op1': { password: '1234', role: 'Operario 1', isAdmin: false },
                'admin': { password: '1234', role: 'Administrador', isAdmin: true }
            };

            this.operationNumber = localStorage.getItem('taller_operation_number') || '';
            this.selectedTool = null;
            
            // Datos
            this.tools = [];
            this.stations = [];
            this.history = [];
            this.colaEspera = [];
            this.materials = [
                { id: 1, name: "Molycote", code: "MOLY-001", status: "disponible", operator: "", station: "", location: "Estante-a1", minQuantity: 2 },
                { id: 2, name: "Loctite 270", code: "LOC-270", status: "disponible", operator: "", station: "", location: "Estante-b2", minQuantity: 2 },
                { id: 3, name: "Molycote", code: "MOLY-002", status: "agotado", operator: "", station: "", location: "Estante-a1", minQuantity: 2 },
                { id: 4, name: "Loctite 270", code: "LOC-271", status: "disponible", operator: "", station: "", location: "E-b2", minQuantity: 2 }
            ];
            
            // Tareas
            this.tasks = [];
            
            // Variables temporales para tareas
            this.currentTaskTools = [];
            this.currentParentModal = null;
			
			// OPERACIONES - ESTA LÍNEA ES CRÍTICA
            this.operations = {};
            
            
            this.init();
        }
        
        async init() {
            try {
                console.log('🔧 Iniciando sistema...');
                
                // Inicializar Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                this.db = firebase.firestore();
                
                // Comprobar sesión guardada
                this.userName = localStorage.getItem('taller_user_name');
                this.userRole = localStorage.getItem('taller_user_role');

                if (this.userName && this.userRole) {
                    const userKey = Object.keys(this.loginUsers).find(key => this.loginUsers[key].role === this.userName);
                    this.userIsAdmin = userKey && this.loginUsers[userKey].isAdmin;
                    
                    this.isLoggedIn = true;
                    this.updateUserProfile();
                    this.hideLoginScreen();
                    this.setupRealtimeListener();
                    this.showNotification(`Sesión reanudada: ${this.userName}`, 'info');
                } else {
                    this.showLoginScreen();
                }
                
                this.setupEventListeners();
                this.setupNavigation();
                this.setupMobileScroll();
                
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error de conexión con Firebase', 'error');
                this.loadDefaultData();
            }
        }
        
        // Lógica de Login
        showLoginScreen() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.querySelector('.app-container').style.display = 'none'; 
            document.getElementById('user-profile-logout-btn').classList.add('logged-out');
            
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.replaceWith(loginButton.cloneNode(true));
                document.getElementById('login-button').addEventListener('click', () => {
                    this.handleLogin();
                });
            }

            const usernameInput = document.getElementById('login-username');
            const passwordInput = document.getElementById('login-password');
            
            if (usernameInput) {
                usernameInput.value = '';
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
            }
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
            }
        }

        hideLoginScreen() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.querySelector('.app-container').style.display = 'grid';
            document.getElementById('user-profile-logout-btn').classList.remove('logged-out');
        }

        handleLogin() {
            const usernameInput = document.getElementById('login-username').value.toLowerCase();
            const passwordInput = document.getElementById('login-password').value;
            const errorMessage = document.getElementById('login-error-message');
            
            const userLoginData = this.loginUsers[usernameInput];

            if (userLoginData && userLoginData.password === passwordInput) {
                this.isLoggedIn = true;
                this.userName = userLoginData.role; 
                this.userRole = usernameInput; 
                this.userIsAdmin = userLoginData.isAdmin;
                
                localStorage.setItem('taller_user_name', this.userName);
                localStorage.setItem('taller_user_role', this.userRole);
                
                this.updateUserProfile();
                this.hideLoginScreen();
                this.updateAdminMenuVisibility();
                errorMessage.style.display = 'none';
                this.showNotification(`Bienvenido, ${this.userName}`, 'success');
                
                this.setupRealtimeListener(); 
                
            } else {
                errorMessage.textContent = 'Usuario o contraseña incorrectos.';
                errorMessage.style.display = 'block';
            }
        }
        
        logout() {
             if (!this.isLoggedIn) return;

            if (this.unsubscribe) {
                this.unsubscribe();
                this.unsubscribe = null;
            }
            
            localStorage.removeItem('taller_user_name');
            localStorage.removeItem('taller_user_role');
            localStorage.removeItem('taller_operation_number'); 

            this.isLoggedIn = false;
            this.userName = '';
            this.userRole = '';
            this.userIsAdmin = false;
            this.operationNumber = '';
            
            this.updateUserProfile(); 
            this.updateAdminMenuVisibility();
            this.showLoginScreen(); 
            
            this.showNotification('Sesión cerrada correctamente.', 'info');
        }

        setupEventListeners() {
            document.getElementById('herramientas-search-tool').addEventListener('input', () => this.renderToolsInHerramientasSection());
            document.getElementById('materiales-search').addEventListener('input', () => this.renderMaterials());
            
			
            const logoutBtn = document.getElementById('user-profile-logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => this.logout());
            }
            
            const addUserBtn = document.getElementById('add-user-btn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => this.showAddUserModal());
            }
            
            const addTaskBtn = document.getElementById('add-task-btn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', () => this.showAddTaskModal());
            }

            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    sidebarOverlay.classList.toggle('active');
                    
                    const icon = menuToggle.querySelector('i');
                    if (sidebar.classList.contains('open')) {
                        icon.className = 'fas fa-times'; 
                    } else {
                        icon.className = 'fas fa-bars';
                    }
                });
                
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                    menuToggle.querySelector('i').className = 'fas fa-bars';
                });
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        if (window.innerWidth <= 1024) {
                            sidebar.classList.remove('open');
                            sidebarOverlay.classList.remove('active');
                            menuToggle.querySelector('i').className = 'fas fa-bars';
                        }
                    });
                });
            }
			            // Eventos para la sección de Operaciones
            const operacionesSearch = document.getElementById('operaciones-search');
            const operacionesFilter = document.getElementById('operaciones-filter');
            
            if (operacionesSearch) {
                operacionesSearch.addEventListener('input', () => this.renderOperacionesList());
            }
            if (operacionesFilter) {
                operacionesFilter.addEventListener('change', () => this.renderOperacionesList());
            }
        }

        setupMobileScroll() {
            document.addEventListener('touchmove', function(e) {
                const allowScrollSelectors = ['.main-content', '.history-table-container', '.table-container', '.sidebar'];
                const isScrollableElement = allowScrollSelectors.some(selector => 
                    e.target.closest(selector) || e.target.matches(selector)
                );
                
                if (!isScrollableElement) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            if ('scrollBehavior' in document.documentElement.style) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }
        }

        setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    if (!this.isLoggedIn && item.getAttribute('data-page') !== 'dashboard') {
                        this.showNotification('Debe iniciar sesión para navegar.', 'warning');
                        return;
                    }

                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    const page = item.getAttribute('data-page');
                    this.showPage(page);
                });
            });
        }

        showPage(page) {
    document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(page).classList.add('active');
    
    if (page === 'herramientas') {
        this.renderToolsInHerramientasSection();
    } else if (page === 'materiales') {
        this.renderMaterials();
    } else if (page === 'tareas') {
        this.renderTasks();
    } else if (page === 'en-espera') {
        this.renderWaitingQueue();
        this.renderCurrentUsageInOperarios();
    } else if (page === 'configuracion') {
    this.renderAdminConfiguration(); // Nueva función de administración
} else if (page === 'operaciones') {
                this.renderOperacionesPage();
            } else if (page === 'instrucciones') {
                this.updateLastSyncTime();
            }
}
        
        
        updateAdminMenuVisibility() {
            const configItem = document.querySelector('.nav-item[data-page="configuracion"]');
            if (configItem) {
                if (this.userIsAdmin) {
                    configItem.classList.add('show');
                } else {
                    configItem.classList.remove('show');
                }
            }
        }

        updateUserProfile() {
            const userName = this.userName || 'No Autenticado';
            const userKey = Object.keys(this.loginUsers).find(key => this.loginUsers[key].role === userName);
            const roleDisplay = userKey ? (this.loginUsers[userKey].isAdmin ? 'Administrador' : 'Operario') : 'Invitado';
            
            const userAvatar = document.getElementById('user-avatar');
            const userNameElement = document.getElementById('user-name');
            const userRoleElement = document.getElementById('user-role');
            
            if (this.isLoggedIn) {
                userAvatar.textContent = userName.substring(0, 2).toUpperCase();
                userNameElement.textContent = userName;
                userRoleElement.textContent = roleDisplay;
                document.getElementById('user-profile-logout-btn').title = 'Click para cerrar sesión';
            } else {
                userAvatar.textContent = '?';
                userNameElement.textContent = 'No Autenticado';
                userRoleElement.textContent = 'Invitado';
                document.getElementById('user-profile-logout-btn').title = 'Debe iniciar sesión';
            }
        }

        showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        getToolHistory(toolId) {
            return this.history.filter(item => item.toolId === toolId || item.numeroSerie === this.tools.find(t => t.id === toolId)?.numeroSerie).slice(0, 5);
        }

// GESTIÓN DE TAREAS
renderTasks() {
    const tasksList = document.getElementById('tasks-list');
    if (!tasksList) return;

    // Ocultar el botón de añadir tarea
    const addTaskBtn = document.getElementById('add-task-btn');
    if (addTaskBtn) {
        addTaskBtn.style.display = 'none';
    }

    if (this.tasks.length === 0) {
        tasksList.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No hay tareas disponibles en este momento.</p>
            </div>
        `;
        return;
    }

    tasksList.innerHTML = '';
    
    // Ordenar tareas: pendientes primero, luego en progreso, luego completadas
    const sortedTasks = [...this.tasks].sort((a, b) => {
        const statusOrder = { 'pendiente': 0, 'en-progreso': 1, 'completada': 2 };
        return statusOrder[a.status] - statusOrder[b.status];
    });

    sortedTasks.forEach(task => {
        const taskCard = document.createElement('div');
        taskCard.className = 'task-card';
        
        let statusClass = 'task-status-pendiente';
        let statusText = 'Pendiente';
        
        if (task.status === 'en-progreso') {
            statusClass = 'task-status-en-progreso';
            statusText = 'En Progreso';
        } else if (task.status === 'completada') {
            statusClass = 'task-status-completada';
            statusText = 'Completada';
        }

        let toolsHTML = '';
        if (task.tools && task.tools.length > 0) {
            toolsHTML = `
                <div class="task-tools">
                    <h4>Herramientas requeridas: ${task.tools.length}</h4>
                    ${task.tools.map(tool => {
                        const toolStatus = this.checkToolAvailability(tool.numeroSerie);
                        return `
                            <div class="tool-requirement">
                                <div class="tool-status-indicator ${toolStatus.available ? 'tool-status-disponible' : 'tool-status-no-disponible'}"></div>
                                <div>
                                    <strong>${tool.name}</strong> (Serie: ${tool.numeroSerie})
                                    <br>
                                    <small>${toolStatus.available ? 'Disponible' : 'No disponible'} - ${toolStatus.message}</small>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            toolsHTML = `
                <div class="task-tools">
                    <h4>Herramientas requeridas: 0</h4>
                    <p style="color: var(--gray-500); text-align: center; padding: 1rem;">
                        No se han seleccionado herramientas para esta tarea.
                    </p>
                </div>
            `;
        }

        let actionsHTML = '';
        if (task.status === 'pendiente') {
            actionsHTML = `
                <div class="task-actions">
                    <button class="btn-task btn-task-primary" onclick="window.tallerSystem.selectToolsForTask(${task.id})">
                        <i class="fas fa-tools"></i> Seleccionar Herramientas
                    </button>
                    <button class="btn-task btn-task-outline" onclick="window.tallerSystem.startTask(${task.id})">
                        <i class="fas fa-play"></i> Iniciar Tarea
                    </button>
                </div>
            `;
        } else if (task.status === 'en-progreso') {
            actionsHTML = `
                <div class="task-actions">
                    <button class="btn-task btn-task-success" onclick="window.tallerSystem.completeTask(${task.id})">
                        <i class="fas fa-check"></i> Completar Tarea
                    </button>
                    <button class="btn-task btn-task-outline" onclick="window.tallerSystem.cancelTask(${task.id})">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            `;
        } else if (task.status === 'completada') {
            actionsHTML = `
                <div class="task-actions">
                    <button class="btn-task btn-task-outline" onclick="window.tallerSystem.deleteTask(${task.id})">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
        }

        // Determinar el título basado en el nombre de la tarea
        let titleHTML = task.name;
        if (task.name.includes("Seccionador")) {
            titleHTML = `<i class="fas fa-bolt"></i> ${task.name}`;
        } else if (task.name.includes("Operación")) {
            titleHTML = `<i class="fas fa-cogs"></i> ${task.name}`;
        }

        taskCard.innerHTML = `
            <div class="task-header">
                <div class="task-title">${titleHTML}</div>
                <div class="task-status ${statusClass}">${statusText}</div>
            </div>
            <div class="task-details">
                <div>
                    <strong>Operación:</strong> ${task.operationNumber}<br>
                    <strong>Descripción:</strong> ${task.description}<br>
                    <strong>Tiempo estimado:</strong> 1.45h
                </div>
                <div>
                    <strong>Asignado a:</strong> ${task.assignedTo || 'No asignado'}<br>
                    <strong>Herramientas:</strong> ${task.tools ? task.tools.length : 0} requeridas<br>
                    <strong>Prioridad:</strong> <span style="color: var(--warning);">Media</span>
                </div>
            </div>
            ${toolsHTML}
            ${actionsHTML}
        `;
        
        tasksList.appendChild(taskCard);
    });
}

        checkToolAvailability(serialNumber) {
    const tool = this.tools.find(t => t.numeroSerie === serialNumber);
    
    if (!tool) {
        return {
            available: false,
            message: 'Herramienta no encontrada en el inventario'
        };
    }
    
    if (tool.status === 'disponible') {
        return {
            available: true,
            message: 'Disponible para uso'
        };
    } else if (tool.status === 'en-uso') {
        // Verificar si está siendo usada en una tarea
        const taskUsingTool = this.tasks.find(t => 
            t.status === 'en-progreso' && 
            t.tools && 
            t.tools.some(toolItem => toolItem.numeroSerie === serialNumber)
        );
        
        if (taskUsingTool) {
            return {
                available: false,
                message: `En uso en tarea: ${taskUsingTool.name}`
            };
        } else {
            return {
                available: false,
                message: `En uso por ${tool.operator}`
            };
        }
    } else if (tool.status === 'mantenimiento') {
        return {
            available: false,
            message: 'En mantenimiento'
        };
    }
    
    return {
        available: false,
        message: 'Estado desconocido'
    };
}

        showAddTaskModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-plus"></i> Crear Nueva Tarea</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label for="task-name">Nombre de la Tarea</label>
                        <input type="text" id="task-name" placeholder="Ej: Operación 150 - Seccionador">
                    </div>
                    <div class="form-group">
                        <label for="task-operation">Número de Operación</label>
                        <input type="text" id="task-operation" placeholder="Ej: 150" value="150">
                    </div>
                    <div class="form-group">
                        <label for="task-description">Descripción</label>
                        <textarea id="task-description" rows="3" placeholder="Descripción detallada de la tarea..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="task-due-date">Fecha Límite (Opcional)</label>
                        <input type="date" id="task-due-date">
                    </div>
                    <p class="error-message" id="add-task-error" style="display:none; color: var(--danger); margin-top: 1rem;"></p>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" id="confirm-add-task">
                            <i class="fas fa-check"></i> Crear Tarea
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-add-task').addEventListener('click', () => {
                this.confirmAddTask(modal);
            });
        }

        selectToolsForTask(taskId) {
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-tools"></i> Seleccionar Herramientas para: ${task.name}</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label for="tool-search">Buscar Herramienta</label>
                        <input type="text" id="tool-search" placeholder="Buscar por nombre o número de serie...">
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                        <table class="tools-table">
                            <thead>
                                <tr>
                                    <th>Herramienta</th>
                                    <th>Número de Serie</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tool-selection-list">
                                ${this.tools.map(tool => `
                                    <tr>
                                        <td>
                                            <div class="tool-info">
                                                <div class="tool-icon-table">
                                                    <i class="${tool.icon}"></i>
                                                </div>
                                                <div class="tool-details">
                                                    <div class="tool-name">${tool.name}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${tool.numeroSerie}</td>
                                        <td>
                                            <span class="tool-status ${tool.status === 'disponible' ? 'status-available' : tool.status === 'en-uso' ? 'status-in-use' : 'status-maintenance'}">
                                                ${tool.status}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn-icon btn-icon-primary" onclick="window.tallerSystem.addToolToTask(${taskId}, '${tool.numeroSerie}', '${tool.name.replace(/'/g, "\\'")}')">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="form-group">
                        <label>Herramientas Seleccionadas</label>
                        <div id="selected-tools-list" style="margin-bottom: 1rem;">
                            ${task.tools && task.tools.length > 0 ? 
                                task.tools.map(tool => `
                                    <div class="tool-requirement">
                                        <div class="tool-status-indicator tool-status-disponible"></div>
                                        <div>
                                            <strong>${tool.name}</strong> (Serie: ${tool.numeroSerie})
                                        </div>
                                        <button class="btn-icon btn-icon-outline" onclick="window.tallerSystem.removeToolFromTask(${taskId}, '${tool.numeroSerie}')" style="margin-left: auto;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p style="color: var(--gray-500);">No se han seleccionado herramientas</p>'
                            }
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Filtro de búsqueda
            modal.querySelector('#tool-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = modal.querySelectorAll('#tool-selection-list tr');
                
                rows.forEach(row => {
                    const toolName = row.querySelector('.tool-name').textContent.toLowerCase();
                    const serialNumber = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    
                    if (toolName.includes(searchTerm) || serialNumber.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        async addToolToTask(taskId, serialNumber, toolName) {
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;

            // Verificar si la herramienta ya está en la lista
            if (task.tools && task.tools.some(tool => tool.numeroSerie === serialNumber)) {
                this.showNotification('Esta herramienta ya está en la lista', 'warning');
                return;
            }

            // Inicializar array de herramientas si no existe
            if (!task.tools) {
                task.tools = [];
            }

            // Añadir herramienta a la lista
            task.tools.push({
                numeroSerie: serialNumber,
                name: toolName
            });

            await this.saveData();
            this.showNotification(`Herramienta ${toolName} añadida a la tarea`, 'success');
            this.renderTasks();
            
            // Cerrar y reabrir el modal para actualizar la lista
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
            this.selectToolsForTask(taskId);
        }

        async removeToolFromTask(taskId, serialNumber) {
            const task = this.tasks.find(t => t.id === taskId);
            if (!task || !task.tools) return;

            const index = task.tools.findIndex(tool => tool.numeroSerie === serialNumber);
            if (index !== -1) {
                task.tools.splice(index, 1);
                await this.saveData();
                this.showNotification('Herramienta removida de la tarea', 'info');
                this.renderTasks();
                
                // Cerrar y reabrir el modal para actualizar la lista
                document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
                this.selectToolsForTask(taskId);
            }
        }

        async confirmAddTask(modal) {
            const name = modal.querySelector('#task-name').value;
            const operationNumber = modal.querySelector('#task-operation').value;
            const description = modal.querySelector('#task-description').value;
            const dueDate = modal.querySelector('#task-due-date').value;
            const errorDisplay = modal.querySelector('#add-task-error');

            if (!name || !operationNumber) {
                errorDisplay.textContent = 'El nombre y número de operación son obligatorios';
                errorDisplay.style.display = 'block';
                return;
            }

            const newTask = {
                id: Date.now(),
                name,
                operationNumber,
                description,
                dueDate: dueDate || null,
                tools: [],
                status: 'pendiente',
                assignedTo: this.userName,
                createdAt: new Date().toISOString(),
                startedAt: null,
                completedAt: null
            };

            this.tasks.push(newTask);
            await this.saveData();
            modal.remove();
            this.showNotification(`Tarea "${name}" creada correctamente`, 'success');
            this.renderTasks();
        }

        async startTask(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (!task) return;

    // Verificar si hay herramientas asignadas a la tarea
    if (!task.tools || task.tools.length === 0) {
        this.showNotification('No se pueden iniciar tareas sin herramientas asignadas', 'warning');
        return;
    }

    // Verificar disponibilidad de herramientas
    const unavailableTools = [];
    task.tools.forEach(tool => {
        const availability = this.checkToolAvailability(tool.numeroSerie);
        if (!availability.available) {
            unavailableTools.push({
                tool: tool.name,
                reason: availability.message
            });
        }
    });

    if (unavailableTools.length > 0) {
        let message = 'No se puede iniciar la tarea. Las siguientes herramientas no están disponibles:\n';
        unavailableTools.forEach(tool => {
            message += `- ${tool.tool}: ${tool.reason}\n`;
        });
        
        this.showNotification(message, 'error');
        return;
    }

    // Bloquear todas las herramientas de la tarea
    task.tools.forEach(tool => {
        const toolIndex = this.tools.findIndex(t => t.numeroSerie === tool.numeroSerie);
        if (toolIndex !== -1) {
            this.tools[toolIndex].status = 'en-uso';
            this.tools[toolIndex].operator = this.userName;
            this.tools[toolIndex].station = 'Tarea: ' + task.name;
            
            // Registrar en el historial
            this.history.unshift({
                tool: this.tools[toolIndex].name,
                action: 'tomada',
                operator: this.userName,
                operationNumber: task.operationNumber,
                station: 'Tarea: ' + task.name,
                time: new Date().toISOString(),
                numeroSerie: tool.numeroSerie,
                taskId: task.id,
                taskName: task.name
            });
        }
    });

    // Actualizar estado de la tarea
    task.status = 'en-progreso';
    task.startedAt = new Date().toISOString();
    task.assignedTo = this.userName;

    await this.saveData();
    this.showNotification(`Tarea "${task.name}" iniciada - Herramientas bloqueadas`, 'success');
    this.renderTasks();
    this.renderToolsInHerramientasSection(); // Actualizar vista de herramientas
}

        async completeTask(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (!task) return;

    // Liberar todas las herramientas de la tarea
    if (task.tools && task.tools.length > 0) {
        task.tools.forEach(tool => {
            const toolIndex = this.tools.findIndex(t => t.numeroSerie === tool.numeroSerie);
            if (toolIndex !== -1 && this.tools[toolIndex].status === 'en-uso') {
                this.tools[toolIndex].status = 'disponible';
                this.tools[toolIndex].operator = '';
                this.tools[toolIndex].station = '';
                
                // Registrar en el historial
                this.history.unshift({
                    tool: this.tools[toolIndex].name,
                    action: 'devuelta',
                    operator: this.userName,
                    operationNumber: task.operationNumber,
                    station: 'Tarea completada: ' + task.name,
                    time: new Date().toISOString(),
                    numeroSerie: tool.numeroSerie,
                    taskId: task.id,
                    taskName: task.name
                });
            }
        });
    }

    task.status = 'completada';
    task.completedAt = new Date().toISOString();

    await this.saveData();
    this.showNotification(`Tarea "${task.name}" completada - Herramientas liberadas`, 'success');
    this.renderTasks();
    this.renderToolsInHerramientasSection(); // Actualizar vista de herramientas
}

        async cancelTask(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (!task) return;

    // Liberar todas las herramientas de la tarea
    if (task.tools && task.tools.length > 0) {
        task.tools.forEach(tool => {
            const toolIndex = this.tools.findIndex(t => t.numeroSerie === tool.numeroSerie);
            if (toolIndex !== -1 && this.tools[toolIndex].status === 'en-uso') {
                this.tools[toolIndex].status = 'disponible';
                this.tools[toolIndex].operator = '';
                this.tools[toolIndex].station = '';
                
                // Registrar en el historial
                this.history.unshift({
                    tool: this.tools[toolIndex].name,
                    action: 'devuelta',
                    operator: this.userName,
                    operationNumber: task.operationNumber,
                    station: 'Tarea cancelada: ' + task.name,
                    time: new Date().toISOString(),
                    numeroSerie: tool.numeroSerie,
                    taskId: task.id,
                    taskName: task.name
                });
            }
        });
    }

    task.status = 'pendiente';
    task.startedAt = null;
    
    await this.saveData();
    this.showNotification(`Tarea "${task.name}" cancelada - Herramientas liberadas`, 'info');
    this.renderTasks();
    this.renderToolsInHerramientasSection(); // Actualizar vista de herramientas
}
        async deleteTask(taskId) {
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;

            this.tasks = this.tasks.filter(t => t.id !== taskId);
            await this.saveData();
            this.showNotification(`Tarea "${task.name}" eliminada`, 'info');
            this.renderTasks();
        }

        exportTaskData(taskId) {
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;

            const taskData = {
                ...task,
                tools: task.tools.map(tool => {
                    const toolInfo = this.tools.find(t => t.numeroSerie === tool.numeroSerie);
                    return {
                        ...tool,
                        toolInfo: toolInfo || null
                    };
                })
            };

            const dataStr = JSON.stringify(taskData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tarea-${task.operationNumber}-${task.name.replace(/\s+/g, '-')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            this.showNotification(`Datos de la tarea "${task.name}" exportados`, 'success');
        }
// GESTIÓN DE INSTRUCCIONES
showOperationInstructions(operationType) {
    const operations = {
        'seccionador': {
            name: 'Operación Seccionador',
            code: '150',
            description: 'Mantenimiento y calibración de seccionador principal',
            documents: [
                { name: 'Manual de Procedimiento Completo', type: 'pdf', url: '#' },
                { name: 'Diagramas Eléctricos', type: 'pdf', url: '#' },
                { name: 'Lista de Herramientas Requeridas', type: 'pdf', url: '#' }
            ],
            steps: [
                'Desenergizar el equipo y verificar ausencia de tensión',
                'Inspeccionar contactos y mecanismos',
                'Realizar calibración de parámetros',
                'Verificar funcionamiento de protecciones',
                'Documentar resultados en formato QA-150'
            ]
        },
        'qb0300': {
            name: 'Operación QB0300',
            code: 'QB0300', 
            description: 'Ensamblaje y verificación de componente QB0300',
            documents: [
                { name: 'Guía de Ensamblaje Paso a Paso', type: 'pdf', url: '#' },
                { name: 'Lista de Verificación Final', type: 'pdf', url: '#' },
                { name: 'Especificaciones Técnicas', type: 'pdf', url: '#' }
            ],
            steps: [
                'Preparar componentes según lista de materiales',
                'Realizar ensamblaje secuencial etapas 1-5',
                'Verificar tolerancias y ajustes',
                'Realizar prueba funcional',
                'Completar documentación de calidad'
            ]
        }
    };

    const operation = operations[operationType];
    if (!operation) return;

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-alt"></i> ${operation.name}</h3>
                <button class="modal-close">&times;</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Columna izquierda: Información -->
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Información de la Operación</h4>
                    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px;">
                        <p><strong>Código:</strong> ${operation.code}</p>
                        <p><strong>Descripción:</strong> ${operation.description}</p>
                        <p><strong>Documentos:</strong> ${operation.documents.length} disponibles</p>
                    </div>

                    <h4 style="color: var(--primary); margin-top: 1.5rem; margin-bottom: 1rem;">Pasos de la Operación</h4>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                        ${operation.steps.map((step, index) => `
                            <div style="display: flex; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; margin-right: 0.75rem; flex-shrink: 0;">
                                    ${index + 1}
                                </div>
                                <span>${step}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Columna derecha: Documentación -->
                <div>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Documentación</h4>
                    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 1rem;">Selecciona un documento para verlo o descargarlo:</p>
                        
                        ${operation.documents.map(doc => `
                            <div class="tool-requirement" style="cursor: pointer; transition: all 0.3s;" onclick="window.tallerSystem.openDocument('${doc.url}', '${doc.name}')">
                                <div class="tool-icon-table" style="background: var(--danger);">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div>
                                    <strong>${doc.name}</strong><br>
                                    <small style="color: var(--gray-600);">Formato PDF</small>
                                </div>
                                <div style="margin-left: auto;">
                                    <i class="fas fa-download" style="color: var(--secondary);"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Espacio para futuras imágenes -->
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Imágenes de Referencia</h4>
                    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; text-align: center;">
                        <i class="fas fa-images" style="font-size: 2rem; color: var(--gray-400); margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--gray-600);">Las imágenes de referencia se cargarán próximamente</p>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button class="btn btn-primary" onclick="window.tallerSystem.startOperationFromInstructions('${operationType}')">
                    <i class="fas fa-play"></i> Iniciar esta Operación
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

// Función para abrir documentos (placeholder por ahora)
openDocument(url, docName) {
    if (url === '#') {
        this.showNotification(`Documento "${docName}" - La funcionalidad de PDF estará disponible próximamente`, 'info');
    } else {
        window.open(url, '_blank');
    }
}

// Función para iniciar operación desde instrucciones
startOperationFromInstructions(operationType) {
    this.showNotification(`Iniciando ${operationType} - Redirigiendo a Tareas...`, 'success');
    
    // Cerrar modal
    document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
    
    // Navegar a la página de tareas
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    document.querySelector('.nav-item[data-page="tareas"]').classList.add('active');
    this.showPage('tareas');
    
    // Aquí podrías automatizar la creación de una tarea relacionada
    setTimeout(() => {
        this.showNotification(`Busca la tarea relacionada con ${operationType} en la lista`, 'info');
    }, 1000);
}

// ADMINISTRACIÓN DEL SISTEMA
renderAdminConfiguration() {
    // Mostrar/ocultar contenido según permisos
    const adminPanel = document.getElementById('admin-access-panel');
    const adminContent = document.getElementById('admin-content');
    
    if (this.userIsAdmin) {
        if (adminPanel) adminPanel.style.display = 'none';
        if (adminContent) adminContent.style.display = 'block';
        this.loadAdminStatistics();
        this.renderOperationsManagement();
        this.renderToolsManagement();
        this.renderMaterialsManagement();
        this.renderUsersManagement();
    } else {
        if (adminPanel) adminPanel.style.display = 'block';
        if (adminContent) adminContent.style.display = 'none';
    }
}

loadAdminStatistics() {
    document.getElementById('config-tools-count').textContent = this.tools.length;
    document.getElementById('config-materials-count').textContent = this.materials.length;
    document.getElementById('config-users-count').textContent = Object.keys(this.loginUsers).length;
}

// GESTIÓN DE OPERACIONES
        renderOperationsManagement() {
            const operationsList = document.getElementById('operations-list');
            if (!operationsList) {
                console.log('❌ operations-list no encontrado en el DOM');
                return;
            }

            console.log('🔄 Renderizando operaciones:', this.operations);

            // Verificar si existen operaciones
            if (!this.operations || Object.keys(this.operations).length === 0) {
                console.log('ℹ️ No hay operaciones configuradas');
                operationsList.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--gray-500);">
                        <i class="fas fa-file-alt"></i><br>
                        No hay operaciones configuradas<br>
                        <small>Crea la primera operación usando el botón "Añadir Nueva Operación"</small>
                    </div>
                `;
                return;
            }

            operationsList.innerHTML = '';
            
            Object.keys(this.operations).forEach(opKey => {
                const op = this.operations[opKey];
                console.log('📋 Renderizando operación:', op);
                
                const opItem = document.createElement('div');
                opItem.className = 'tool-requirement';
                opItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${op.name}</strong><br>
                        <small>Código: ${op.code} | ${op.description}</small>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-icon btn-icon-outline" title="Editar" onclick="window.tallerSystem.editOperation('${opKey}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-icon-danger" title="Eliminar" onclick="window.tallerSystem.deleteOperation('${opKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                operationsList.appendChild(opItem);
            });

            // Actualizar el contador
            const count = Object.keys(this.operations).length;
            document.getElementById('config-operations-count').textContent = count;
            console.log('✅ Operaciones renderizadas:', count);
        }

showAddOperationModal() {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado. Se requiere permisos de administrador.', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-plus"></i> Añadir Nueva Operación</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="form-group">
                <label for="new-op-name">Nombre de la Operación</label>
                <input type="text" id="new-op-name" placeholder="Ej: Operación Transformador">
            </div>
            <div class="form-group">
                <label for="new-op-code">Código de Operación</label>
                <input type="text" id="new-op-code" placeholder="Ej: 200">
            </div>
            <div class="form-group">
                <label for="new-op-description">Descripción</label>
                <textarea id="new-op-description" rows="3" placeholder="Descripción detallada de la operación..."></textarea>
            </div>
            <p class="error-message" id="add-op-error" style="display:none; color: var(--danger);"></p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn btn-primary" onclick="window.tallerSystem.confirmAddOperation(this.closest('.modal-overlay'))">
                    <i class="fas fa-check"></i> Crear Operación
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

        async confirmAddOperation(modal) {
            const name = modal.querySelector('#new-op-name').value;
            const code = modal.querySelector('#new-op-code').value;
            const description = modal.querySelector('#new-op-description').value;
            const errorDisplay = modal.querySelector('#add-op-error');

            if (!name || !code) {
                errorDisplay.textContent = 'El nombre y código son obligatorios';
                errorDisplay.style.display = 'block';
                return;
            }

            console.log('🆕 Creando nueva operación:', { name, code, description });

            // Asegurar que operations existe
            if (!this.operations) {
                console.log('⚠️ Operations no existía, inicializando...');
                this.operations = {};
            }

            // Crear ID único
            const operationId = 'op_' + Date.now();
            const newOperation = {
                id: operationId,
                name: name,
                code: code,
                description: description,
                documents: [
                    { name: 'Manual de Procedimiento', type: 'pdf', url: '#' },
                    { name: 'Diagramas Técnicos', type: 'pdf', url: '#' }
                ],
                steps: [
                    'Paso 1: Preparar el área de trabajo',
                    'Paso 2: Revisar herramientas requeridas',
                    'Paso 3: Ejecutar procedimiento según especificaciones',
                    'Paso 4: Verificar resultados',
                    'Paso 5: Documentar el proceso'
                ]
            };

            console.log('📝 Nueva operación a guardar:', newOperation);

            // Añadir a operations
            this.operations[operationId] = newOperation;

            try {
                console.log('💾 Intentando guardar en Firebase...');
                await this.saveData();
                console.log('✅ Operación guardada exitosamente');
                
                this.showNotification(`Operación "${name}" creada correctamente`, 'success');
                modal.remove();
                this.renderOperationsManagement();
            } catch (error) {
                console.error('❌ Error al guardar operación:', error);
                this.showNotification('Error al guardar la operación: ' + error.message, 'error');
            }
        }

// GESTIÓN DE HERRAMIENTAS
renderToolsManagement() {
    const toolsList = document.getElementById('tools-management-list');
    if (!toolsList) return;

    toolsList.innerHTML = '';
    
    this.tools.slice(0, 5).forEach(tool => {
        const toolItem = document.createElement('div');
        toolItem.className = 'tool-requirement';
        toolItem.innerHTML = `
            <div style="flex: 1;">
                <strong>${tool.name}</strong><br>
                <small>Serie: ${tool.numeroSerie} | ${tool.status}</small>
            </div>
            <div class="action-buttons">
                <button class="btn-icon btn-icon-outline" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-icon-danger" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        toolsList.appendChild(toolItem);
    });

    if (this.tools.length > 5) {
        const moreItem = document.createElement('div');
        moreItem.style.textAlign = 'center';
        moreItem.style.padding = '0.5rem';
        moreItem.style.color = 'var(--secondary)';
        moreItem.innerHTML = `<small>+ ${this.tools.length - 5} herramientas más...</small>`;
        toolsList.appendChild(moreItem);
    }
}

showAddToolModal() {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado. Se requiere permisos de administrador.', 'error');
        return;
    }
    this.showNotification('Funcionalidad de añadir herramientas en desarrollo', 'info');
}
        // SECCIÓN OPERACIONES - PARA OPERARIOS
        renderOperacionesPage() {
            this.updateLastSyncTime();
            this.renderOperacionesList();
        }

        renderOperacionesList() {
            const operacionesList = document.getElementById('operaciones-list');
            if (!operacionesList) return;

            // Verificar si hay operaciones
            if (!this.operations || Object.keys(this.operations).length === 0) {
                operacionesList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--gray-500);">
                        <i class="fas fa-cogs" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                        <h3>No hay operaciones disponibles</h3>
                        <p>El administrador aún no ha configurado operaciones en el sistema.</p>
                    </div>
                `;
                return;
            }

            const searchTerm = document.getElementById('operaciones-search').value.toLowerCase();
            const filterValue = document.getElementById('operaciones-filter').value;

            operacionesList.innerHTML = '';

            Object.keys(this.operations).forEach(opKey => {
                const operacion = this.operations[opKey];
                
                // Aplicar filtros
                if (searchTerm && !operacion.name.toLowerCase().includes(searchTerm) && 
                    !operacion.description.toLowerCase().includes(searchTerm) &&
                    !operacion.code.toLowerCase().includes(searchTerm)) {
                    return;
                }

                // Determinar categoría y color
                let categoria = 'general';
                let color = 'var(--secondary)';
                let icono = 'fas fa-cogs';

                if (operacion.name.toLowerCase().includes('seccionador') || operacion.name.toLowerCase().includes('eléctrico')) {
                    categoria = 'mantenimiento';
                    color = 'var(--warning)';
                    icono = 'fas fa-bolt';
                } else if (operacion.name.toLowerCase().includes('ensamblaje') || operacion.name.toLowerCase().includes('qb0300')) {
                    categoria = 'ensamblaje';
                    color = 'var(--success)';
                    icono = 'fas fa-puzzle-piece';
                } else if (operacion.name.toLowerCase().includes('calibración') || operacion.name.toLowerCase().includes('calibracion')) {
                    categoria = 'calibracion';
                    color = 'var(--accent)';
                    icono = 'fas fa-tachometer-alt';
                }

                // Aplicar filtro de categoría
                if (filterValue !== 'todas' && categoria !== filterValue) {
                    return;
                }

                // Crear tarjeta de operación
                const operacionCard = document.createElement('div');
                operacionCard.className = 'task-card';
                operacionCard.style.cursor = 'pointer';
                operacionCard.style.borderLeft = `4px solid ${color}`;
                operacionCard.addEventListener('click', () => this.showOperacionDetails(opKey));

                // Verificar si hay tareas activas para esta operación
                const tareasActivas = this.tasks.filter(task => 
                    task.operationNumber === operacion.code && 
                    task.status === 'en-progreso'
                ).length;

                operacionCard.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">
                            <i class="${icono}" style="color: ${color};"></i> ${operacion.name}
                        </div>
                        <div class="task-status ${tareasActivas > 0 ? 'task-status-en-progreso' : 'task-status-pendiente'}">
                            ${tareasActivas > 0 ? `${tareasActivas} activa(s)` : 'Disponible'}
                        </div>
                    </div>
                    
                    <div class="task-details">
                        <div>
                            <strong>Código:</strong> ${operacion.code}<br>
                            <strong>Categoría:</strong> <span style="color: ${color}; text-transform: capitalize;">${categoria}</span>
                        </div>
                        <div>
                            <strong>Documentos:</strong> ${operacion.documents ? operacion.documents.length : 0}<br>
                            <strong>Pasos:</strong> ${operacion.steps ? operacion.steps.length : 0}
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <p style="color: var(--gray-600); font-size: 0.9rem; margin-bottom: 1rem;">
                            ${operacion.description}
                        </p>
                    </div>

                    <div class="task-actions">
                        <button class="btn-task btn-task-primary" onclick="event.stopPropagation(); window.tallerSystem.verInstruccionesOperacion('${opKey}')">
                            <i class="fas fa-file-alt"></i> Ver Instrucciones
                        </button>
                        <button class="btn-task btn-task-success" onclick="event.stopPropagation(); window.tallerSystem.crearTareaDesdeOperacion('${opKey}')">
                            <i class="fas fa-play"></i> Iniciar Operación
                        </button>
                    </div>
                `;

                operacionesList.appendChild(operacionCard);
            });

            // Si no hay resultados después de filtrar
            if (operacionesList.children.length === 0) {
                operacionesList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>No se encontraron operaciones</h3>
                        <p>Intenta con otros términos de búsqueda o ajusta los filtros.</p>
                    </div>
                `;
            }
        }

        verInstruccionesOperacion(operationKey) {
            this.showOperationInstructions(operationKey);
        }

        async crearTareaDesdeOperacion(operationKey) {
            if (!this.isLoggedIn) {
                this.showNotification('Debes iniciar sesión para crear una tarea', 'warning');
                return;
            }

            const operacion = this.operations[operationKey];
            if (!operacion) {
                this.showNotification('Operación no encontrada', 'error');
                return;
            }

            // Crear nueva tarea basada en la operación
            const nuevaTarea = {
                id: Date.now(),
                name: operacion.name,
                operationNumber: operacion.code,
                description: operacion.description,
                tools: operacion.herramientasRequeridas || [],
                status: 'pendiente',
                assignedTo: this.userName,
                createdAt: new Date().toISOString(),
                startedAt: null,
                completedAt: null,
                operacionId: operationKey
            };

            this.tasks.push(nuevaTarea);
            await this.saveData();

            this.showNotification(`Tarea "${operacion.name}" creada correctamente`, 'success');
            
            // Opcional: Redirigir a la página de tareas
            setTimeout(() => {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelector('.nav-item[data-page="tareas"]').classList.add('active');
                this.showPage('tareas');
            }, 1500);
        }

        showOperacionDetails(operationKey) {
            const operacion = this.operations[operationKey];
            if (!operacion) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-info-circle"></i> Detalles de la Operación</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--secondary), var(--accent)); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; font-size: 1.5rem;">${operacion.name}</h2>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Código: ${operacion.code}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="color: var(--primary); margin-bottom: 0.75rem;">Información General</h4>
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <p><strong>Descripción:</strong><br>${operacion.description}</p>
                                <p><strong>Documentos disponibles:</strong> ${operacion.documents ? operacion.documents.length : 0}</p>
                                <p><strong>Pasos definidos:</strong> ${operacion.steps ? operacion.steps.length : 0}</p>
                            </div>
                        </div>

                        <div>
                            <h4 style="color: var(--primary); margin-bottom: 0.75rem;">Acciones Rápidas</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-primary" onclick="window.tallerSystem.verInstruccionesOperacion('${operationKey}'); this.closest('.modal-overlay').remove();">
                                    <i class="fas fa-file-alt"></i> Ver Instrucciones Completas
                                </button>
                                <button class="btn btn-success" onclick="window.tallerSystem.crearTareaDesdeOperacion('${operationKey}'); this.closest('.modal-overlay').remove();">
                                    <i class="fas fa-play"></i> Crear Tarea para esta Operación
                                </button>
                                <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 0.75rem;">Pasos Principales</h4>
                        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                            ${operacion.steps ? operacion.steps.slice(0, 3).map((step, index) => `
                                <div style="display: flex; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div style="background: var(--secondary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; margin-right: 0.75rem; flex-shrink: 0;">
                                        ${index + 1}
                                    </div>
                                    <span style="font-size: 0.9rem;">${step}</span>
                                </div>
                            `).join('') : '<p>No hay pasos definidos para esta operación.</p>'}
                            ${operacion.steps && operacion.steps.length > 3 ? 
                                `<p style="text-align: center; color: var(--gray-600); margin-top: 0.5rem;">
                                    ... y ${operacion.steps.length - 3} pasos más
                                </p>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
// GESTIÓN DE MATERIALES
renderMaterialsManagement() {
    const materialsList = document.getElementById('materials-management-list');
    if (!materialsList) return;

    materialsList.innerHTML = '';
    
    this.materials.slice(0, 5).forEach(material => {
        const materialItem = document.createElement('div');
        materialItem.className = 'tool-requirement';
        materialItem.innerHTML = `
            <div style="flex: 1;">
                <strong>${material.name}</strong><br>
                <small>Código: ${material.code} | Stock: ${material.quantity}</small>
            </div>
            <div class="action-buttons">
                <button class="btn-icon btn-icon-outline" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-icon-warning" title="Reponer Stock">
                    <i class="fas fa-boxes"></i>
                </button>
            </div>
        `;
        materialsList.appendChild(materialItem);
    });

    if (this.materials.length > 5) {
        const moreItem = document.createElement('div');
        moreItem.style.textAlign = 'center';
        moreItem.style.padding = '0.5rem';
        moreItem.style.color = 'var(--secondary)';
        moreItem.innerHTML = `<small>+ ${this.materials.length - 5} materiales más...</small>`;
        materialsList.appendChild(moreItem);
    }
}

showAddMaterialModal() {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado. Se requiere permisos de administrador.', 'error');
        return;
    }
    this.showNotification('Funcionalidad de añadir materiales en desarrollo', 'info');
}

// GESTIÓN DE USUARIOS
renderUsersManagement() {
    const usersList = document.getElementById('users-management-list');
    if (!usersList) return;

    usersList.innerHTML = '';
    
    Object.keys(this.loginUsers).forEach(userId => {
        const user = this.loginUsers[userId];
        const userItem = document.createElement('div');
        userItem.className = 'tool-requirement';
        userItem.innerHTML = `
            <div style="flex: 1;">
                <strong>${user.role}</strong><br>
                <small>ID: ${userId} | ${user.isAdmin ? 'Administrador' : 'Operario'}</small>
            </div>
            <div class="action-buttons">
                <button class="btn-icon btn-icon-outline" title="Cambiar Contraseña" onclick="window.tallerSystem.showChangePasswordModal('${userId}', '${user.role}')">
                    <i class="fas fa-lock"></i>
                </button>
                <button class="btn-icon btn-icon-danger" title="Eliminar" onclick="window.tallerSystem.deleteUser('${userId}', '${user.role}')" ${userId === 'admin' ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        usersList.appendChild(userItem);
    });
}

// FUNCIONES DEL SISTEMA
exportSystemData() {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado.', 'error');
        return;
    }

    const systemData = {
        tools: this.tools,
        materials: this.materials,
        users: this.loginUsers,
        history: this.history,
        exportDate: new Date().toISOString()
    };

    const dataStr = JSON.stringify(systemData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', `backup-sistema-${new Date().toISOString().split('T')[0]}.json`);
    linkElement.click();
    
    this.showNotification('Datos del sistema exportados correctamente', 'success');
}

saveSystemSettings() {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado.', 'error');
        return;
    }

    const systemName = document.getElementById('system-name').value;
    const autoSave = document.getElementById('auto-save').value;
    
    // Aquí guardarías las configuraciones en Firebase
    this.showNotification('Configuraciones del sistema guardadas', 'success');
}

editOperation(operationKey) {
    this.showNotification(`Editando operación: ${operationKey}`, 'info');
}

deleteOperation(operationKey) {
    if (!this.userIsAdmin) {
        this.showNotification('Acceso denegado.', 'error');
        return;
    }

    if (confirm(`¿Está seguro de que desea eliminar la operación ${operationKey}?`)) {
        this.showNotification(`Operación ${operationKey} eliminada`, 'success');
        this.renderOperationsManagement();
    }
}

        // GESTIÓN DE USUARIOS (CONFIGURACIÓN)
        renderUserList() {
            const tbody = document.getElementById('user-list-body');
            if (!tbody) return;
            
            if (!this.userIsAdmin) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger);">Acceso denegado. Solo para administradores.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            Object.keys(this.loginUsers).forEach(userKey => {
                const user = this.loginUsers[userKey];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${userKey}</strong></td>
                    <td>${user.role}</td>
                    <td>****</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-icon-outline" title="Cambiar Contraseña" onclick="window.tallerSystem.showChangePasswordModal('${userKey}', '${user.role}')">
                                <i class="fas fa-lock"></i>
                            </button>
                            <button class="btn-icon btn-icon-danger" title="Eliminar Usuario" onclick="window.tallerSystem.deleteUser('${userKey}', '${user.role}')" ${userKey === 'admin' ? 'disabled title="No se puede eliminar al Administrador principal"' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        showAddUserModal() {
            if (!this.userIsAdmin) {
                this.showNotification('Permiso denegado.', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-user-plus"></i> Añadir Nuevo Usuario</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label for="new-user-id"><i class="fas fa-user-tag"></i> ID de Usuario (Ej: op2)</label>
                        <input type="text" id="new-user-id" placeholder="Ingrese un ID único (Ej: op2)">
                    </div>
                     <div class="form-group">
                        <label for="new-user-role-name"><i class="fas fa-signature"></i> Nombre del Rol</label>
                        <input type="text" id="new-user-role-name" placeholder="Ej: Operario 2">
                    </div>
                    <div class="form-group">
                        <label for="new-user-password"><i class="fas fa-key"></i> Contraseña Inicial</label>
                        <input type="password" id="new-user-password" placeholder="Ingrese la contraseña">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="new-user-is-admin" style="width: auto;">
                        <label for="new-user-is-admin" style="margin: 0;"><i class="fas fa-shield-alt"></i> Es Administrador</label>
                    </div>
                    <p class="error-message" id="add-user-error" style="display:none; color: var(--danger); margin-top: 1rem;"></p>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" id="confirm-add-user">
                            <i class="fas fa-check"></i> Guardar Usuario
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-add-user').addEventListener('click', () => this.confirmAddUser(modal));
        }

        confirmAddUser(modal) {
            const id = modal.querySelector('#new-user-id').value.trim().toLowerCase();
            const roleName = modal.querySelector('#new-user-role-name').value.trim();
            const password = modal.querySelector('#new-user-password').value;
            const isAdmin = modal.querySelector('#new-user-is-admin').checked;
            const errorDisplay = modal.querySelector('#add-user-error');

            if (!id || !roleName || !password) {
                errorDisplay.textContent = 'Todos los campos son obligatorios.';
                errorDisplay.style.display = 'block';
                return;
            }
            if (this.loginUsers[id]) {
                errorDisplay.textContent = 'Ese ID de usuario ya existe.';
                errorDisplay.style.display = 'block';
                return;
            }

            this.loginUsers[id] = {
                password: password,
                role: roleName,
                isAdmin: isAdmin
            };
            localStorage.setItem('taller_login_users', JSON.stringify(this.loginUsers));
            
            modal.remove();
            this.renderUserList();
            this.showNotification(`Usuario **${roleName}** añadido.`, 'success');
        }
        
        showChangePasswordModal(userId, roleName) {
             if (!this.userIsAdmin) {
                this.showNotification('Permiso denegado.', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-key"></i> Cambiar Contraseña</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <p>Cambiar contraseña para: <strong>${roleName} (${userId})</strong></p>
                    <div class="form-group">
                        <label for="new-password"><i class="fas fa-lock"></i> Nueva Contraseña</label>
                        <input type="password" id="new-password" placeholder="Ingrese la nueva contraseña">
                    </div>
                    <p class="error-message" id="password-error" style="display:none; color: var(--danger); margin-top: 1rem;"></p>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-warning" id="confirm-password-change">
                            <i class="fas fa-check"></i> Cambiar Contraseña
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-password-change').addEventListener('click', () => {
                const newPassword = modal.querySelector('#new-password').value;
                if (newPassword.length < 4) {
                    modal.querySelector('#password-error').textContent = 'La contraseña debe tener al menos 4 caracteres.';
                    modal.querySelector('#password-error').style.display = 'block';
                    return;
                }
                this.loginUsers[userId].password = newPassword;
                localStorage.setItem('taller_login_users', JSON.stringify(this.loginUsers));
                modal.remove();
                this.showNotification(`Contraseña de **${roleName}** actualizada.`, 'success');
            });
        }

        deleteUser(userId, roleName) {
            if (!this.userIsAdmin) {
                this.showNotification('Permiso denegado.', 'error');
                return;
            }
             if (userId === 'admin') {
                this.showNotification('No se puede eliminar al Administrador principal.', 'error');
                return;
            }
            
            if (confirm(`¿Está seguro de que desea eliminar al usuario ${roleName} (${userId})? Esta acción no se puede deshacer.`)) {
                delete this.loginUsers[userId];
                localStorage.setItem('taller_login_users', JSON.stringify(this.loginUsers));
                this.renderUserList();
                this.showNotification(`Usuario **${roleName}** eliminado.`, 'danger');
            }
        }
        
        // MÉTODOS FIREBASE
        setupRealtimeListener() {
            try {
                this.unsubscribe = this.db.collection('tallerData').doc('herramientas').onSnapshot(doc => {
                    if (doc.exists) {
                        this.processData(doc.data());
                    } else {
                        this.createInitialData();
                    }
                }, err => {
                    console.error('Error en listener:', err);
                    this.showNotification('Error de conexión en tiempo real', 'error');
                    this.loadDefaultData();
                });
            } catch (error) {
                console.error('Error en listener:', error);
                this.loadDefaultData();
            }
        }

        processData(data) {
            this.tools = data.tools || this.getDefaultTools();
            this.stations = data.stations || this.getDefaultStations();
            this.history = data.history || [];
            this.colaEspera = data.colaEspera || [];
            this.materials = data.materials || this.getDefaultMaterials();
            this.tasks = data.tasks || [];
            
			// OPERACIONES - ESTA LÍNEA ES CLAVE
            this.operations = data.operations || this.getDefaultOperations();
            
            console.log('✅ Operaciones cargadas:', this.operations);
            this.renderAll();
            this.updateLastSyncTime();
        }

        renderAll() {
            this.renderStations();
            this.renderHistoryTable();
            this.updateStats();
            this.renderWaitingQueue();
            this.renderToolsInHerramientasSection();
            this.renderCurrentUsageInOperarios();
            this.renderMaterials();
            this.renderTasks();
        }

        // DATOS POR DEFECTO
        getDefaultTools() {
            return [
                { id: 1, name: "Llave Dinamométrica M12 56Nm", status: "disponible", operator: "", station: "", icon: "fas fa-tachometer-alt", isTorque: true, location: "estante-1", grupo: "Dinamométricas", numeroSerie: "LD-001" },
                { id: 2, name: "Llave Dinamométrica M10 32Nm", status: "disponible", operator: "", station: "", icon: "fas fa-tachometer-alt", isTorque: true, location: "estante-1", grupo: "Dinamométricas", numeroSerie: "LD-002" },
                { id: 3, name: "Llave Dinamométrica M8 16,2Nm", status: "disponible", operator: "", station: "", icon: "fas fa-tachometer-alt", isTorque: true, location: "estante-2", grupo: "Dinamométricas", numeroSerie: "LD-003" },
                { id: 4, name: "Llave Dinamométrica M6 6,8Nm", status: "disponible", operator: "", station: "", icon: "fas fa-tachometer-alt", isTorque: true, location: "estante-2", grupo: "Dinamométricas", numeroSerie: "LD-004" },
                { id: 5, name: "Destornillador TORX T30", status: "disponible", operator: "", station: "", icon: "fas fa-screwdriver", isTorque: false, location: "estante-3", grupo: "destornilladores", numeroSerie: "" },
                { id: 6, name: "LLave 22", status: "disponible", operator: "", station: "", icon: "fas fa-wrench", isTorque: true, location: "estante-3", grupo: "Llaves", numeroSerie: "" },
                { id: 7, name: "Llave 18", status: "disponible", operator: "", station: "", icon: "fas fa-wrench", isTorque: true, location: "estante-4", grupo: "Llaves", numeroSerie: "" },
                { id: 8, name: "Llave 13", status: "disponible", operator: "", station: "", icon: "fas fa-wrench", isTorque: false, location: "estante-4", grupo: "Llaves", numeroSerie: "" },
            ];
        }

        getDefaultMaterials() {
            return [
                { id: 1, name: "Molycote", code: "MOLY-001", status: "disponible", operator: "", station: "", location: "Estante-a1" },
                { id: 2, name: "Loctite 270", code: "LOC-270", status: "disponible", operator: "", station: "", location: "Estante-b2"},
                { id: 3, name: "Loctite 244", code: "LOC-002", status: "disponible", operator: "", station: "", location: "Estante-a1"},
                { id: 4, name: "Loctite 222", code: "LOC-222", status: "disponible", operator: "", station: "", location: "Estante-b2"}
            ];
        }

// Agregar esta función para obtener tareas por defecto
getDefaultTasks() {
    return [
        {
            id: 1,
            name: "Seccionador",
            operationNumber: "150",
            description: "Mantenimiento y calibración de seccionador principal",
            tools: [
                { numeroSerie: "TQ100-001", name: "Torquímetro 20-100 Nm" },
                { numeroSerie: "DP-001", name: "Destornillador Plano" }
            ],
            status: 'pendiente',
            assignedTo: 'Operario 1',
            createdAt: new Date().toISOString(),
            startedAt: null,
            completedAt: null
        },
        {
            id: 2,
            name: "Operación 200 - Transformador",
            operationNumber: "200",
            description: "Revisión y mantenimiento de transformador de potencia",
            tools: [
                { numeroSerie: "LE10-001", name: "Llave Inglesa 10mm" },
                { numeroSerie: "LI-001", name: "Llave de Impacto" }
            ],
            status: 'pendiente',
            assignedTo: 'Operario 2',
            createdAt: new Date().toISOString(),
            startedAt: null,
            completedAt: null
        }
    ];
}

        getDefaultStations() {
            return [
                { id: "estacion-0", name: "Estación 0" },
                { id: "estacion-1", name: "Estación 1" },
                { id: "estacion-2", name: "Estación 2" },
                { id: "estacion-3", name: "Estación 3" },
                { id: "estacion-4", name: "Estación 4" },
                { id: "estacion-5", name: "Estación 5" }
            ];
        }

        loadDefaultData() {
            this.tools = this.getDefaultTools();
            this.stations = this.getDefaultStations();
            this.history = [];
            this.colaEspera = [];
            this.materials = this.getDefaultMaterials();
            this.tasks = [];
			this.tasks = this.getDefaultTasks();
            this.renderAll();
        }
		
		        getDefaultOperations() {
            return {
                'seccionador': {
                    id: 'seccionador',
                    name: 'Operación Seccionador',
                    code: '150',
                    description: 'Mantenimiento y calibración de seccionador principal',
                    documents: [
                        { name: 'Manual de Procedimiento Completo', type: 'pdf', url: '#' },
                        { name: 'Diagramas Eléctricos', type: 'pdf', url: '#' },
                        { name: 'Lista de Herramientas Requeridas', type: 'pdf', url: '#' }
                    ],
                    steps: [
                        'Desenergizar el equipo y verificar ausencia de tensión',
                        'Inspeccionar contactos y mecanismos',
                        'Realizar calibración de parámetros',
                        'Verificar funcionamiento de protecciones',
                        'Documentar resultados en formato QA-150'
                    ]
                },
                'qb0300': {
                    id: 'qb0300',
                    name: 'Operación QB0300',
                    code: 'QB0300', 
                    description: 'Ensamblaje y verificación de componente QB0300',
                    documents: [
                        { name: 'Guía de Ensamblaje Paso a Paso', type: 'pdf', url: '#' },
                        { name: 'Lista de Verificación Final', type: 'pdf', url: '#' },
                        { name: 'Especificaciones Técnicas', type: 'pdf', url: '#' }
                    ],
                    steps: [
                        'Preparar componentes según lista de materiales',
                        'Realizar ensamblaje secuencial etapas 1-5',
                        'Verificar tolerancias y ajustes',
                        'Realizar prueba funcional',
                        'Completar documentación de calidad'
                    ]
                }
            };
        }

        // MÉTODOS FIREBASE
        async createInitialData() {
            try {
                const defaultData = {
                    tools: this.getDefaultTools(),
                    stations: this.getDefaultStations(),
                    history: [],
                    colaEspera: [],
                    materials: this.materials,
                    tasks: this.getDefaultTasks(),
                    operations: this.getDefaultOperations(), // NUEVO
                    users: {},
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await this.db.collection('tallerData').doc('herramientas').set(defaultData);
                this.showNotification('Datos iniciales creados en Firebase', 'info');
            } catch (error) {
                console.error('Error creando datos:', error);
                this.showNotification('Error al crear datos iniciales', 'error');
            }
        }

                async saveData() {
            try {
                console.log('💾 Guardando datos en Firebase...', {
                    tools: this.tools.length,
                    operations: Object.keys(this.operations).length
                });
                
                const dataToSave = {
                    tools: this.tools,
                    history: this.history,
                    colaEspera: this.colaEspera,
                    materials: this.materials,
                    tasks: this.tasks,
                    operations: this.operations, // Asegurar que operations se guarda
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                };

                await this.db.collection('tallerData').doc('herramientas').set(dataToSave, { merge: true });
                
                console.log('✅ Datos guardados exitosamente');
                this.updateLastSyncTime();
            } catch (error) {
                console.error('❌ Error guardando:', error);
                this.showNotification('Error al guardar datos', 'error');
            }
        }

        // GESTIÓN DE HERRAMIENTAS
        renderToolsInHerramientasSection() {
            const toolList = document.getElementById('herramientas-tool-list');
            if (!toolList) return;

            const searchTerm = document.getElementById('herramientas-search-tool').value.toLowerCase();
            let filteredTools = this.tools;

            if (searchTerm) {
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) || 
                    (tool.numeroSerie && tool.numeroSerie.toLowerCase().includes(searchTerm))
                );
            }

            filteredTools.sort((a, b) => {
                const isAUserTool = a.operator === this.userName;
                const isBUserTool = b.operator === this.userName;

                if (isAUserTool && !isBUserTool) {
                    return -1;
                }
                if (!isAUserTool && isBUserTool) {
                    return 1;
                }
                if (a.status === 'en-uso' && b.status !== 'en-uso') {
                    return -1;
                }
                if (a.status !== 'en-uso' && b.status === 'en-uso') {
                    return 1;
                }
                return a.name.localeCompare(b.name);
            });

            if (filteredTools.length === 0) {
                toolList.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 2rem;">No se encontraron herramientas.</td></tr>`;
                return;
            }

            toolList.innerHTML = '';
            
            filteredTools.forEach(tool => {
                const row = document.createElement('tr');
                const isUserTool = tool.operator === this.userName && tool.status === 'en-uso';

                if (isUserTool) {
                    row.style.background = 'linear-gradient(90deg, rgba(45, 116, 218, 0.05) 0%, rgba(255, 255, 255, 1) 50%)';
                    row.style.borderLeft = '4px solid var(--secondary)';
                }

                let statusClass = 'status-available';
                let statusText = 'Disponible';
                let statusIcon = 'fas fa-check-circle';
                if (tool.status === 'en-uso') {
                    statusClass = 'status-in-use';
                    statusText = 'En Uso';
                    statusIcon = 'fas fa-user-check';
                } else if (tool.status === 'mantenimiento') {
                    statusClass = 'status-maintenance';
                    statusText = 'Mantenimiento';
                    statusIcon = 'fas fa-toolbox';
                }

                let ubicacionHTML = '';

if (tool.status === 'en-uso' && tool.station) {
    // Verificar si es una tarea
    if (tool.station.startsWith('Tarea: ')) {
        const taskName = tool.station.replace('Tarea: ', '');
        ubicacionHTML = `
            <div class="user-badge" style="background: rgba(245, 158, 11, 0.1); padding: 0.5rem; border-radius: 8px; border: 1px solid var(--warning);">
                <div class="user-avatar-small" style="background: var(--warning);">${tool.operator.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                <span style="color: var(--warning); font-weight: 600;">
                    ${taskName} <span style="color: var(--warning); font-size: 0.7rem; margin-left: 0.5rem;">(EN TAREA)</span>
                </span>
            </div>
        `;
    } else {
        const stationName = this.getStationName(tool.station);
        if (isUserTool) {
            ubicacionHTML = `
                <div class="user-badge" style="background: rgba(45, 116, 218, 0.1); padding: 0.5rem; border-radius: 8px; border: 1px solid var(--secondary);">
                    <div class="user-avatar-small" style="background: var(--secondary);">${this.userName.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                    <span style="color: var(--secondary); font-weight: 600;">
                        ${stationName} <span style="color: var(--success); font-size: 0.7rem; margin-left: 0.5rem;">(TÚ)</span>
                    </span>
                </div>
            `;
        } else {
            ubicacionHTML = `
                <div class="user-badge">
                    <div class="user-avatar-small">${tool.operator.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                    <span>${stationName}</span>
                </div>
            `;
        }
    }
} else if (tool.status === 'mantenimiento') {
    ubicacionHTML = `<span style="color: var(--danger); font-weight: 600;">Taller</span>`;
} else {
    ubicacionHTML = `<span>${tool.location}</span>`;
}

                let accionesHTML = '';
                if (tool.status === 'disponible') {
                    accionesHTML = `
                        <div class="action-buttons">
                            <button class="btn-icon btn-icon-primary" title="Tomar herramienta" onclick="window.tallerSystem.showTakeToolModal(${tool.id})">
                                <i class="fas fa-hand-paper"></i>
                            </button>
                            <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showToolDetailsModal(${tool.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    `;
                } else if (isUserTool) {
                    accionesHTML = `
                        <div class="action-buttons">
                            <button class="btn-icon btn-icon-success" title="Devolver herramienta" onclick="window.tallerSystem.showReturnToolModal(${tool.id})">
                                <i class="fas fa-reply"></i>
                            </button>
                            <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showToolDetailsModal(${tool.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    `;
                } else if (tool.status === 'en-uso') {
                    const userInQueue = this.colaEspera.some(item => item.toolId === tool.id && item.operator === this.userName);
                    if (!userInQueue) {
                        accionesHTML = `
                            <div class="action-buttons">
                                <button class="btn-icon btn-icon-warning" title="Unirse a la cola" onclick="window.tallerSystem.showJoinQueueModal(${tool.id})">
                                    <i class="fas fa-users"></i>
                                </button>
                                <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showToolDetailsModal(${tool.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        const queueItem = this.colaEspera.find(item => item.toolId === tool.id && item.operator === this.userName);
                        accionesHTML = `
                            <div class="action-buttons">
                                <button class="btn-icon btn-icon-danger" title="Cancelar reserva en cola" onclick="window.tallerSystem.cancelQueueReservation(${tool.id}, '${tool.name}')">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showToolDetailsModal(${tool.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                    }
                } else if (tool.status === 'mantenimiento') {
                    accionesHTML = `
                        <div class="action-buttons">
                            <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showToolDetailsModal(${tool.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td>
                        <div class="tool-info">
                            <div class="tool-icon-table">
                                <i class="${tool.icon}"></i>
                            </div>
                            <div class="tool-details">
                                <div class="tool-name" style="${isUserTool ? 'color: var(--secondary); font-weight: 700;' : ''}">
                                    ${tool.name} ${isUserTool ? '<span style="color: var(--success); font-size: 0.7rem; margin-left: 0.5rem;">(EN TU PODER)</span>' : ''}
                                </div>
                                <div class="tool-status ${statusClass}">
                                    <i class="${statusIcon}"></i> ${statusText}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>${tool.numeroSerie}</td>
                    <td>${ubicacionHTML}</td>
                    <td>${accionesHTML}</td>
                `;
                toolList.appendChild(row);
            });
        }

        // GESTIÓN DE MATERIALES
renderMaterials() {
    const materialsList = document.getElementById('materiales-list');
    if (!materialsList) return;

    const searchTerm = document.getElementById('materiales-search').value.toLowerCase();
    let filteredMaterials = this.materials;

    if (searchTerm) {
        filteredMaterials = filteredMaterials.filter(material => 
            material.name.toLowerCase().includes(searchTerm) || 
            material.code.toLowerCase().includes(searchTerm)
        );
    }

    // ORDENAR: Primero los materiales en uso por el usuario actual, luego en uso por otros, luego disponibles, luego agotados
    filteredMaterials.sort((a, b) => {
        const aIsUserMaterial = a.status === 'en-uso' && a.operator === this.userName;
        const bIsUserMaterial = b.status === 'en-uso' && b.operator === this.userName;
        
        // Primero: Materiales en uso por el usuario actual
        if (aIsUserMaterial && !bIsUserMaterial) return -1;
        if (!aIsUserMaterial && bIsUserMaterial) return 1;
        
        // Segundo: Materiales en uso por otros
        const aInUse = a.status === 'en-uso';
        const bInUse = b.status === 'en-uso';
        if (aInUse && !bInUse) return -1;
        if (!aInUse && bInUse) return 1;
        
        // Tercero: Materiales disponibles vs agotados
        const aAvailable = a.status === 'disponible' && a.quantity > 0;
        const bAvailable = b.status === 'disponible' && b.quantity > 0;
        if (aAvailable && !bAvailable) return -1;
        if (!aAvailable && bAvailable) return 1;
        
        // Cuarto: Por nombre
        return a.name.localeCompare(b.name);
    });

    if (filteredMaterials.length === 0) {
        materialsList.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--gray-500); padding: 2rem;">No se encontraron materiales.</td></tr>`;
        return;
    }

    materialsList.innerHTML = '';
    
    // Agrupar materiales por operador (para los que están en uso)
    const materialesPorOperador = {};
    const materialesDisponibles = [];
    const materialesAgotados = [];

    filteredMaterials.forEach(material => {
        if (material.status === 'en-uso' && material.operator) {
            if (!materialesPorOperador[material.operator]) {
                materialesPorOperador[material.operator] = [];
            }
            materialesPorOperador[material.operator].push(material);
        } else if (material.quantity === 0) {
            materialesAgotados.push(material);
        } else {
            materialesDisponibles.push(material);
        }
    });

    // Función para renderizar una lista de materiales
    const renderMaterialList = (materials, title = null) => {
        if (title) {
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <td colspan="4" style="background: var(--gray-100); padding: 0.75rem 1rem; font-weight: 600; color: var(--primary); border-bottom: 2px solid var(--gray-300);">
                    <i class="fas fa-users"></i> ${title}
                </td>
            `;
            materialsList.appendChild(headerRow);
        }

        materials.forEach(material => {
            const row = document.createElement('tr');
            const isUserMaterial = material.operator === this.userName && material.status === 'en-uso';

            // Destacar fila del usuario actual
            if (isUserMaterial) {
                row.style.background = 'linear-gradient(90deg, rgba(45, 116, 218, 0.05) 0%, rgba(255, 255, 255, 1) 50%)';
                row.style.borderLeft = '4px solid var(--secondary)';
            } else if (material.status === 'en-uso') {
                // Destacar otros materiales en uso
                row.style.background = 'linear-gradient(90deg, rgba(245, 158, 11, 0.05) 0%, rgba(255, 255, 255, 1) 50%)';
                row.style.borderLeft = '4px solid var(--warning)';
            } else if (material.quantity === 0) {
                // Destacar materiales agotados
                row.style.background = 'linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, rgba(255, 255, 255, 1) 50%)';
                row.style.borderLeft = '4px solid var(--danger)';
            }

            let ubicacionHTML = '';
            
            if (material.status === 'en-uso' && material.station) {
                const stationName = this.getStationName(material.station);
                if (isUserMaterial) {
                    ubicacionHTML = `
                        <div class="user-badge" style="background: rgba(45, 116, 218, 0.1); padding: 0.5rem; border-radius: 8px; border: 1px solid var(--secondary);">
                            <div class="user-avatar-small" style="background: var(--secondary);">${this.userName.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                            <span style="color: var(--secondary); font-weight: 600;">
                                ${stationName} <span style="color: var(--success); font-size: 0.7rem; margin-left: 0.5rem;">(TÚ)</span>
                            </span>
                        </div>
                    `;
                } else {
                    ubicacionHTML = `
                        <div class="user-badge">
                            <div class="user-avatar-small">${material.operator.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                            <span>${stationName}</span>
                        </div>
                    `;
                }
            } else if (material.quantity === 0) {
                ubicacionHTML = `<span style="color: var(--danger); font-weight: 600;">Almacén (Agotado)</span>`;
            } else {
                ubicacionHTML = `<span>${material.location}</span>`;
            }

            let accionesHTML = '';
            if (material.status === 'disponible' && material.quantity > 0) {
                accionesHTML = `
                    <div class="action-buttons">
                        <button class="btn-icon btn-icon-primary" title="Tomar material" onclick="window.tallerSystem.showTakeMaterialModal(${material.id})">
                            <i class="fas fa-hand-paper"></i>
                        </button>
                        <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showMaterialDetailsModal(${material.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            } else if (isUserMaterial) {
                accionesHTML = `
                    <div class="action-buttons">
                        <button class="btn-icon btn-icon-success" title="Devolver material" onclick="window.tallerSystem.showReturnMaterialModal(${material.id})">
                            <i class="fas fa-reply"></i>
                        </button>
                        <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showMaterialDetailsModal(${material.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            } else if (material.status === 'en-uso') {
                accionesHTML = `
                    <div class="action-buttons">
                        <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showMaterialDetailsModal(${material.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            } else if (material.quantity === 0) {
                accionesHTML = `
                    <div class="action-buttons">
                        <button class="btn-icon btn-icon-outline" title="Ver detalles" onclick="window.tallerSystem.showMaterialDetailsModal(${material.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;
            }

// En la función renderMaterials, cambiar las referencias a cantidad por estado
let materialInfoHTML = `
    <div class="tool-info">
        <div class="tool-icon-table" style="background: var(--accent);">
            <i class="fas fa-flask"></i>
        </div>
        <div class="tool-details">
            <div class="tool-name" style="${isUserMaterial ? 'color: var(--secondary); font-weight: 700;' : material.status === 'en-uso' ? 'color: var(--warning); font-weight: 600;' : ''}">
                ${material.name} 
                ${isUserMaterial ? '<span style="color: var(--success); font-size: 0.7rem; margin-left: 0.5rem;">(EN TU PODER)</span>' : 
                  material.status === 'en-uso' ? '<span style="color: var(--warning); font-size: 0.7rem; margin-left: 0.5rem;">(EN USO)</span>' : ''}
            </div>
            <div class="tool-status ${material.status === 'en-uso' ? 'status-in-use' : 'status-available'}">
                <i class="fas ${material.status === 'en-uso' ? 'fa-user-check' : 'fa-check-circle'}"></i> 
                ${material.status === 'en-uso' ? 'En Uso' : 'Disponible'}
            </div>
        </div>
    </div>
`;

            row.innerHTML = `
                <td>${materialInfoHTML}</td>
                <td>${material.code}</td>
                <td>${ubicacionHTML}</td>
                <td>${accionesHTML}</td>
            `;
            materialsList.appendChild(row);
        });
    };

    // Renderizar en este orden:
    // 1. Materiales en uso por el usuario actual
    if (materialesPorOperador[this.userName]) {
        renderMaterialList(materialesPorOperador[this.userName], `En uso por: ${this.userName} (TÚ)`);
    }

    // 2. Materiales en uso por otros operadores
    Object.keys(materialesPorOperador).forEach(operador => {
        if (operador !== this.userName) {
            renderMaterialList(materialesPorOperador[operador], `En uso por: ${operador}`);
        }
    });

    // 3. Materiales disponibles
    if (materialesDisponibles.length > 0) {
        renderMaterialList(materialesDisponibles, 'Materiales Disponibles');
    }

    // 4. Materiales agotados
    if (materialesAgotados.length > 0) {
        renderMaterialList(materialesAgotados, 'Materiales Agotados');
    }
}

        // Función para mostrar modal de tomar material
        showTakeMaterialModal(materialId) {
            const material = this.materials.find(m => m.id === materialId);
            if (!material) return;
            
            if (!this.isLoggedIn) {
                this.showNotification('Debes iniciar sesión para tomar un material.', 'warning');
                return;
            }
            
            if (material.quantity <= 0) {
                this.showNotification('Este material está agotado.', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Tomar Material</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-flask"></i> Material seleccionado</label>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                            <strong>${material.name}</strong><br>
                            <small>Código: ${material.code}</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="take-material-operation-number"><i class="fas fa-hashtag"></i> Número de Operación</label>
                        <input type="text" id="take-material-operation-number" placeholder="Ingrese el número de operación" value="${this.operationNumber}">
                    </div>
                    <div class="form-group">
                        <label for="take-material-station"><i class="fas fa-industry"></i> Estación de Trabajo</label>
                        <select id="take-material-station">
                            <option value="">Seleccione una estación</option>
                            ${this.stations.map(station => 
                                `<option value="${station.id}">${station.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" id="confirm-take-material-modal">
                            <i class="fas fa-check"></i> Confirmar Toma
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-take-material-modal').addEventListener('click', () => {
                this.confirmTakeMaterial(material, modal);
            });
        }

        // Función para confirmar toma de material
        async confirmTakeMaterial(material, modal) {
    const operationNumber = modal.querySelector('#take-material-operation-number').value;
    const station = modal.querySelector('#take-material-station').value;
    const operator = this.userName;

    if (!operationNumber) {
        this.showNotification('Ingrese el número de operación', 'warning');
        return;
    }
    if (!station) {
        this.showNotification('Seleccione una estación', 'warning');
        return;
    }

    // Actualizar material (sin lógica de cantidad)
    const materialIndex = this.materials.findIndex(m => m.id === material.id);
    
    if (this.materials[materialIndex].status !== 'disponible') {
        this.showNotification('Este material ya no está disponible.', 'error');
        modal.remove();
        this.renderMaterials();
        return;
    }

    this.materials[materialIndex].status = 'en-uso';
    this.materials[materialIndex].operator = operator;
    this.materials[materialIndex].station = station;

    // Historial
    this.history.unshift({
        tool: material.name,
        action: 'tomada',
        operator: operator,
        operationNumber: operationNumber,
        station: this.getStationName(station),
        time: new Date().toISOString(),
        numeroSerie: material.code,
        type: 'material'
    });

    this.operationNumber = operationNumber;
    localStorage.setItem('taller_operation_number', this.operationNumber);
    await this.saveData();
    modal.remove();
    this.showNotification(`Material tomado: ${material.name}`, 'success');
    this.renderMaterials();
}

        // Función para confirmar devolución de material
     async confirmReturnMaterial(material, modal) {
    const materialIndex = this.materials.findIndex(m => m.id === material.id);
    const operator = this.userName;
    const operationNumber = this.operationNumber;
    const station = material.station;

    // Actualizar material (sin cantidad)
    this.materials[materialIndex].status = 'disponible';
    this.materials[materialIndex].operator = '';
    this.materials[materialIndex].station = '';

    // Agregar al historial
    this.history.unshift({
        tool: material.name,
        action: 'devuelta',
        operator: operator,
        operationNumber: operationNumber,
        station: this.getStationName(station),
        time: new Date().toISOString(),
        numeroSerie: material.code,
        type: 'material'
    });
    await this.saveData();
    modal.remove();
    this.showNotification(`Material devuelto: ${material.name}`, 'success');
    this.renderMaterials();
}

        // Función para mostrar detalles de material
        showMaterialDetailsModal(materialId) {
            const material = this.materials.find(m => m.id === materialId);
            if (!material) return;

            const materialHistory = this.history.filter(item => item.numeroSerie === material.code && item.type === 'material').slice(0, 3);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-flask"></i> Detalles de Material</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">${material.name}</h4>
                    
                    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Código:</strong> ${material.code}<br>
                            <strong>Ubicación:</strong> ${material.location}<br>
                            
                        </div>
                        <div>
                            <strong>Cantidad actual:</strong> ${material.quantity} unidades<br>
                            <strong>Estado:</strong> <span class="status-badge ${material.quantity === 0 ? 'status-maintenance' : material.status === 'en-uso' ? 'status-in-use' : 'status-available'}">
                                ${material.quantity === 0 ? 'Agotado' : material.status === 'en-uso' ? 'En Uso' : 'Disponible'}
                            </span>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: var(--primary); margin-bottom: 1rem;">Historial Reciente</h5>
                        ${materialHistory.length === 0 ? '<p style="color: var(--gray-500); text-align: center;">No hay historial registrado</p>' : 
                            materialHistory.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div>
                                        <strong>${item.operator}</strong><br>
                                        <small style="color: var(--gray-600);">${new Date(item.time).toLocaleString()}</small>
                                    </div>
                                    <span class="status-badge ${item.action === 'tomada' ? 'status-in-use' : 'status-available'}" style="font-size: 0.7rem;">
                                        ${item.action}
                                    </span>
                                </div>
                            `).join('') 
                        }
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        getStationName(stationId) {
            const station = this.stations.find(s => s.id === stationId);
            return station ? station.name : 'Desconocida';
        }

        // MODAL PARA TOMAR HERRAMIENTA
        showTakeToolModal(toolId) {
            const tool = this.tools.find(t => t.id === toolId);
            if (!tool) return;
            
            if (!this.isLoggedIn) {
                this.showNotification('Debes iniciar sesión para tomar una herramienta.', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Tomar Herramienta</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Herramienta seleccionada</label>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                            <strong>${tool.name}</strong><br>
                            <small>Serie: ${tool.numeroSerie} | Grupo: ${tool.grupo}</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="take-operation-number"><i class="fas fa-hashtag"></i> Número de Operación</label>
                        <input type="text" id="take-operation-number" placeholder="Ingrese el número de operación" value="${this.operationNumber}">
                    </div>
                    <div class="form-group">
                        <label for="take-station"><i class="fas fa-industry"></i> Estación de Trabajo</label>
                        <select id="take-station">
                            <option value="">Seleccione una estación</option>
                            ${this.stations.map(station => 
                                `<option value="${station.id}">${station.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" id="confirm-take-tool-modal">
                            <i class="fas fa-check"></i> Confirmar Toma
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-take-tool-modal').addEventListener('click', () => {
                this.confirmTakeTool(tool, modal);
            });
        }

        async confirmTakeTool(tool, modal) {
            const operationNumber = modal.querySelector('#take-operation-number').value;
            const station = modal.querySelector('#take-station').value;
            const operator = this.userName;

            if (!operationNumber) {
                this.showNotification('Ingrese el número de operación', 'warning');
                return;
            }
            if (!station) {
                this.showNotification('Seleccione una estación', 'warning');
                return;
            }

            const toolIndex = this.tools.findIndex(t => t.id === tool.id);
            this.tools[toolIndex].status = 'en-uso';
            this.tools[toolIndex].operator = operator;
            this.tools[toolIndex].station = station;

            this.history.unshift({
                tool: tool.name,
                action: 'tomada',
                operator: operator,
                operationNumber: operationNumber,
                station: this.getStationName(station),
                time: new Date().toISOString(),
                numeroSerie: tool.numeroSerie
            });

            this.operationNumber = operationNumber;
            localStorage.setItem('taller_operation_number', this.operationNumber);

            await this.saveData();
            modal.remove();
            this.showNotification(`Herramienta tomada: ${tool.name}`, 'success');
        }

        // MODAL PARA DEVOLVER HERRAMIENTA
        showReturnToolModal(toolId) {
            const tool = this.tools.find(t => t.id === toolId);
            if (!tool) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Devolver Herramienta</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Herramienta a devolver</label>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                            <strong>${tool.name}</strong><br>
                            <small>Serie: ${tool.numeroSerie} | Estación: ${this.getStationName(tool.station)}</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Ubicación para devolución</label>
                        <div style="padding: 1rem; background: var(--success); color: white; border-radius: 8px; text-align: center;">
                            <i class="fas fa-arrow-down"></i><br>
                            <strong>${tool.location}</strong><br>
                            <small>Llevar la herramienta a esta ubicación</small>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-success" id="confirm-return-tool">
                            <i class="fas fa-check"></i> Confirmar Devolución
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-return-tool').addEventListener('click', () => {
                this.confirmReturnTool(tool, modal);
            });
        }

        async confirmReturnTool(tool, modal) {
            const toolIndex = this.tools.findIndex(t => t.id === tool.id);
            const operator = this.userName;
            const operationNumber = this.operationNumber;
            const station = tool.station;

            this.tools[toolIndex].status = 'disponible';
            this.tools[toolIndex].operator = '';
            this.tools[toolIndex].station = '';

            this.history.unshift({
                tool: tool.name,
                action: 'devuelta',
                operator: operator,
                operationNumber: operationNumber,
                station: this.getStationName(station),
                time: new Date().toISOString(),
                numeroSerie: tool.numeroSerie
            });

            await this.saveData();
            modal.remove();
            this.showNotification(`Herramienta devuelta: ${tool.name}`, 'success');
        }

        // MODAL PARA UNIRSE A LA COLA
        showJoinQueueModal(toolId) {
            const tool = this.tools.find(t => t.id === toolId);
            if (!tool) return;

            if (!this.isLoggedIn) {
                this.showNotification('Debes iniciar sesión para unirte a la cola.', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-users"></i> Unirse a la Cola</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="queue-modal-info">
                        Estás solicitando la herramienta: <strong>${tool.name}</strong> (Serie: ${tool.numeroSerie})
                    </div>
                    <div class="form-group">
                        <label for="queue-operation-number"><i class="fas fa-hashtag"></i> Número de Operación</label>
                        <input type="text" id="queue-operation-number" placeholder="Ingrese el número de operación" value="${this.operationNumber}">
                    </div>
                    <div class="form-group">
                        <label for="queue-station-modal"><i class="fas fa-industry"></i> Estación de Trabajo</label>
                        <select id="queue-station-modal">
                            <option value="">Seleccione su estación</option>
                            ${this.stations.map(station => 
                                `<option value="${station.id}">${station.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-warning" id="confirm-join-queue">
                            <i class="fas fa-users"></i> Unirse a la Cola
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            modal.querySelector('#confirm-join-queue').addEventListener('click', () => {
                this.confirmJoinQueue(tool, modal);
            });
        }

        async confirmJoinQueue(tool, modal) {
            const operationNumber = modal.querySelector('#queue-operation-number').value;
            const station = modal.querySelector('#queue-station-modal').value;

            if (!operationNumber) {
                this.showNotification('Ingrese el número de operación', 'warning');
                return;
            }
            if (!station) {
                this.showNotification('Seleccione una estación', 'warning');
                return;
            }

            const alreadyInQueue = this.colaEspera.some(item => 
                item.toolId === tool.id && item.operator === this.userName 
            );

            if (alreadyInQueue) {
                this.showNotification('Ya estás en la cola de espera para esta herramienta', 'warning');
                return;
            }

            this.colaEspera.push({
                toolId: tool.id,
                toolName: tool.name,
                toolSerial: tool.numeroSerie,
                operator: this.userName,
                operationNumber: operationNumber,
                station: station,
                time: new Date().toISOString()
            });

            this.operationNumber = operationNumber;
            localStorage.setItem('taller_operation_number', this.operationNumber);

            await this.saveData();
            modal.remove();
            this.showNotification(`Te has unido a la cola de espera para ${tool.name}`, 'success');
        }

        // CANCELAR RESERVA EN LA COLA
        async cancelQueueReservation(toolId, toolName) {
            const index = this.colaEspera.findIndex(item => 
                item.toolId === toolId && item.operator === this.userName 
            );

            if (index !== -1) {
                this.colaEspera.splice(index, 1);
                await this.saveData();
                this.showNotification(`Has cancelado tu reserva en la cola para ${toolName}`, 'info');
            }
        }

        // RENDERIZADO DE COLA DE ESPERA
        renderWaitingQueue() {
            const waitingList = document.getElementById('waiting-list');
            if (!waitingList) return;

            const toolsInUseOrMaint = this.tools.filter(t => t.status !== 'disponible').map(t => t.id);
            const colaFiltrada = this.colaEspera.filter(item => toolsInUseOrMaint.includes(item.toolId));

            if (colaFiltrada.length === 0) {
                waitingList.innerHTML = `
                    <div class="queue-info-message">
                        <i class="fas fa-check"></i> No hay operarios en espera por herramientas en uso.
                    </div>
                `;
                return;
            }

            waitingList.innerHTML = '';
            
            const colaAgrupada = colaFiltrada.reduce((acc, item) => {
                const tool = this.tools.find(t => t.id === item.toolId);
                const key = tool ? tool.name : 'Herramienta Desconocida';
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(item);
                return acc;
            }, {});

            Object.keys(colaAgrupada).forEach(toolName => {
                const groupHeader = document.createElement('h5');
                groupHeader.className = 'queue-group-header';
                groupHeader.innerHTML = `<i class="fas fa-tools"></i> ${toolName}`;
                waitingList.appendChild(groupHeader);
                
                colaAgrupada[toolName].forEach((item, index) => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';

                    const isFirstInLine = index === 0;
                    const isCurrentUser = item.operator === this.userName;

                    if (isFirstInLine) {
                        queueItem.classList.add('first-in-line');
                    }
                    if (isCurrentUser) {
                        queueItem.classList.add('current-user');
                    }

                    const positionHTML = isFirstInLine 
                        ? `<span class="queue-position first">${index + 1}</span>`
                        : `<span class="queue-position">${index + 1}</span>`;
                    
                    const queueInfo = document.createElement('div');
                    queueInfo.className = 'queue-info';
                    let indicators = '';
                    if (isFirstInLine) {
                        indicators += `<span class="first-in-line-indicator"><i class="fas fa-crown"></i> PRÓXIMO</span>`;
                    }
                    if (isCurrentUser) {
                        indicators += `<span class="current-user-indicator"><i class="fas fa-user"></i> TÚ</span>`;
                    }

                    queueInfo.innerHTML = `
                        ${positionHTML}
                        <div style="margin-left: 20px;">
                            <strong>${item.operator}</strong>${indicators}<br>
                            <small>Operación: ${item.operationNumber} - ${this.getStationName(item.station)}</small>
                        </div>
                    `;

                    const queueActions = document.createElement('div');
                    queueActions.className = 'queue-actions';

                    if (isCurrentUser) {
                        queueActions.innerHTML = `
                            <button class="btn-cancel-queue" onclick="window.tallerSystem.cancelQueueReservation(${item.toolId}, '${item.toolName}')">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        `;
                    }

                    queueItem.appendChild(queueInfo);
                    queueItem.appendChild(queueActions);
                    waitingList.appendChild(queueItem);
                });
            });
        }

        // RENDERIZADO DE HERRAMIENTAS EN USO ACTUALMENTE
        renderCurrentUsageInOperarios() {
            const currentUsage = document.getElementById('operarios-current-usage');
            if (!currentUsage) return;
            
            const herramientasEnUso = this.tools.filter(tool => tool.status === 'en-uso');
            
            if (herramientasEnUso.length === 0) {
                currentUsage.innerHTML = `
                    <div class="current-usage-item">
                        <div>No hay herramientas en uso</div>
                    </div>
                `;
                return;
            }
            
            currentUsage.innerHTML = '';
            
            herramientasEnUso.forEach(tool => {
                const usageItem = document.createElement('div');
                usageItem.className = 'current-usage-item';
                
                const nextInQueue = this.colaEspera.find(item => item.toolId === tool.id);
                let nextInQueueHTML = '';
                if (nextInQueue) {
                    nextInQueueHTML = `
                        <span style="font-size: 0.8rem; color: var(--success);">
                            Próximo: <strong>${nextInQueue.operator}</strong>
                        </span>
                    `;
                }

                usageItem.innerHTML = `
                    <div>
                        <strong>${tool.name}</strong> (${tool.numeroSerie})<br>
                        <small>En uso por: ${tool.operator} - ${this.getStationName(tool.station)}</small>
                    </div>
                    <div style="text-align: right; margin-top: 5px;">
                        ${nextInQueueHTML}
                    </div>
                `;
                currentUsage.appendChild(usageItem);
            });
        }

        // RENDERIZADO DE ESTACIONES
        renderStations() {
            const stationsContainer = document.getElementById('stations');
            if (!stationsContainer) return;
            stationsContainer.innerHTML = '';

            this.stations.forEach((station, index) => {
                const toolsInStation = this.tools.filter(tool => 
                    tool.status === 'en-uso' && tool.station === station.id
                );

                const stationCard = document.createElement('div');
                stationCard.className = `station-card estacion-${index}`;
                
                let toolsListHTML = toolsInStation.length > 0 ? 
                    toolsInStation.map(tool => `
                        <div class="tool-in-station">
                            <i class="${tool.icon}"></i> 
                            <span>${tool.name}</span>
                        </div>
                    `).join('') :
                    '<p style="color: var(--gray-500); font-size: 0.875rem;">Sin herramientas en uso.</p>';

                stationCard.innerHTML = `
                    <i class="fas fa-industry"></i>
                    <div class="station-label">${station.name}</div>
                    <div class="station-value">${toolsInStation.length}</div>
                    <div class="station-label" style="margin-bottom: 0;">Herramientas en Uso</div>
                    <div class="station-tools">
                        ${toolsListHTML}
                    </div>
                `;
                stationsContainer.appendChild(stationCard);
            });
        }

        // RENDERIZADO DE HISTORIAL
        renderHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            if (!tbody) return;

            if (this.history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray-500);">No hay historial</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            this.history.slice(0, 50).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.operator}</strong></td>
                    <td>${new Date(item.time).toLocaleString()}</td>
                    <td>${item.tool}</td>
                    <td>${item.numeroSerie || '-'}</td>
                    <td>${item.operationNumber || '-'}</td>
                    <td>
                        <span class="status-badge ${item.action === 'tomada' ? 'status-in-use' : 'status-available'}">
                            ${item.action}
                        </span>
                    </td>
                    <td>${item.station}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ACTUALIZACIÓN DE ESTADÍSTICAS
        updateStats() {
            const disponible = this.tools.filter(t => t.status === 'disponible').length;
            const enUso = this.tools.filter(t => t.status === 'en-uso').length;
            const mantenimiento = this.tools.filter(t => t.status === 'mantenimiento').length;
            
            const toolsInUseOrMaint = this.tools.filter(t => t.status !== 'disponible').map(t => t.id);
            const enCola = this.colaEspera.filter(item => toolsInUseOrMaint.includes(item.toolId)).length;
            
            document.getElementById('disponible-count').textContent = disponible;
            document.getElementById('en-uso-count').textContent = enUso;
            document.getElementById('mantenimiento-count').textContent = mantenimiento;
            document.getElementById('en-cola-count').textContent = enCola;

            if (this.isLoggedIn) {
                document.getElementById('sidebar-update-time').textContent = new Date().toLocaleTimeString();
            }
        }

        updateLastSyncTime() {
            const now = new Date().toLocaleTimeString();
            document.getElementById('update-time').textContent = now;
            document.getElementById('sidebar-update-time').textContent = now;
            document.getElementById('herramientas-update').textContent = now;
            document.getElementById('en-espera-update').textContent = now;
            document.getElementById('materiales-update').textContent = now;
            document.getElementById('tareas-update').textContent = now;
			document.getElementById('operaciones-update').textContent = now;
        }


        // DETALLES DE HERRAMIENTA
        showToolDetailsModal(toolId) {
            const tool = this.tools.find(t => t.id === toolId);
            if (!tool) return;

            const toolHistory = this.history.filter(item => item.numeroSerie === tool.numeroSerie).slice(0, 3);
            const grupoTools = this.tools.filter(t => t.grupo === tool.grupo);
            const disponibles = grupoTools.filter(t => t.status === 'disponible').length;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="${tool.icon}"></i> Detalles de Herramienta</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">${tool.name}</h4>
                    
                    <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Grupo:</strong> ${tool.grupo}<br>
                            <strong>Ubicación:</strong> ${tool.location}<br>
                            <strong>Tipo:</strong> ${tool.isTorque ? 'Dinamométrica' : 'Manual'}
                        </div>
                        <div>
                            <strong>Estado:</strong> <span class="status-badge ${tool.status === 'disponible' ? 'status-available' : tool.status === 'en-uso' ? 'status-in-use' : 'status-maintenance'}">${tool.status}</span><br>
                            <strong>En grupo:</strong> ${disponibles}/${grupoTools.length} disp.
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: var(--primary); margin-bottom: 1rem;">Historial Reciente</h5>
                        ${toolHistory.length === 0 ? '<p style="color: var(--gray-500); text-align: center;">No hay historial registrado</p>' : 
                            toolHistory.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div>
                                        <strong>${item.operator}</strong><br>
                                        <small style="color: var(--gray-600);">${new Date(item.time).toLocaleString()}</small>
                                    </div>
                                    <span class="status-badge ${item.action === 'tomada' ? 'status-in-use' : 'status-available'}" style="font-size: 0.7rem;">
                                        ${item.action}
                                    </span>
                                </div>
                            `).join('') 
                        }
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
    }

    // INICIAR SISTEMA
    document.addEventListener('DOMContentLoaded', () => {
        window.tallerSystem = new TallerSystem();
    });
</script>             
               
               
</body>
</html>
